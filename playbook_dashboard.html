<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Alva · Playbook Dashboard</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* Page-specific styles for dashboard */
      .paper { background: #ffffff; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .paper .hd { padding: 16px 20px 12px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; }
      .hd-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }
      .hd-left { display: flex; align-items: center; gap: 10px; }
      .hd-avatar { width: 32px; height: 32px; border-radius: 50%; overflow: hidden; flex-shrink: 0; }
      .hd-avatar img { width: 100%; height: 100%; object-fit: cover; }
      .hd-user { font-size: 13px; color: #6b7280; font-weight: 500; }
      .hd-sep { color: #d1d5db; font-size: 13px; }
      .hd-trend-icon { display: flex; align-items: center; color: #6b7280; }
      .hd-trend-icon svg { width: 16px; height: 16px; }
      .hd-title { font-size: 15px; font-weight: 600; color: #111827; }
      .hd-status { width: 8px; height: 8px; border-radius: 50%; background: #14b8a6; flex-shrink: 0; }
      .hd-actions { display: flex; align-items: center; gap: 12px; }
      .hd-action-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); border-radius: 50%; background: #fff; color: #6b7280; cursor: pointer; transition: all 0.2s; }
      .hd-action-btn:hover { border-color: #d1d5db; color: #374151; background: #f9fafb; }
      .hd-action-btn svg { width: 16px; height: 16px; }
      .hd-action-btn-text { border: 1px solid #14b8a6; background: #ecfdf5; color: #0f766e; border-radius: 8px; padding: 6px 14px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
      .hd-action-btn-text:hover { background: #d1fae5; border-color: #0f766e; }
      .share-dd { position: relative; }
      .share-panel { position: absolute; top: calc(100% + 8px); right: 0; width: 360px; background: #ffffff; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.12); display: none; z-index: 50; }
      .share-panel.open { display: block; }
      .share-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); }
      .share-title { font-size: 14px; font-weight: 600; color: #111827; }
      .share-close { border: 0; background: transparent; color: #6b7280; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s; }
      .share-close:hover { background: #f3f4f6; color: #374151; }
      .share-body { padding: 14px; }
      .share-visibility { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
      .share-visibility-label { font-size: 13px; font-weight: 500; color: #374151; }
      .share-toggle { display: flex; align-items: center; gap: 10px; }
      .share-toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
      .share-toggle-switch input { opacity: 0; width: 0; height: 0; }
      .share-toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #14b8a6; transition: 0.3s; border-radius: 24px; }
      .share-toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; }
      .share-toggle-switch input:checked + .share-toggle-slider { background-color: #14b8a6; }
      .share-toggle-switch input:not(:checked) + .share-toggle-slider { background-color: #d1d5db; }
      .share-toggle-switch input:checked + .share-toggle-slider:before { transform: translateX(20px); }
      .share-toggle-label { font-size: 13px; font-weight: 500; color: #374151; }
      .share-url-section { display: block; }
      .share-url-section.hidden { display: none; }
      .share-url-label { font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 8px; }
      .share-url-input-group { display: flex; gap: 8px; }
      .share-url-input { flex: 1; border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 12px; color: #6b7280; background: #f9fafb; }
      .share-copy-btn { border: 1px solid #14b8a6; background: #ecfdf5; color: #0f766e; border-radius: 8px; padding: 8px 16px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
      .share-copy-btn:hover { background: #d1fae5; border-color: #0f766e; }
      .share-copy-btn.copied { background: #d1fae5; color: #059669; }
      .tabs { display: flex; gap: 24px; }
      .tab { padding: 6px 0; border: none; background: transparent; color: #6b7280; font-size: 14px; font-weight: 500; cursor: pointer; position: relative; transition: color 0.2s; }
      .tab:hover { color: #374151; }
      .tab.active { color: #111827; font-weight: 600; }
      .tab.active::after { content: ''; position: absolute; bottom: -12px; left: 0; right: 0; height: 2px; background: #14b8a6; border-radius: 1px; }
      .paper .bd { padding: 12px 14px; }
      #dashPanel { display: flex; flex-direction: column; position: relative; }
      #dashPanel .bd { flex: 1; }
      .title { font-weight: 700; }
      .last-updated { color: var(--muted); font-size: 12px; }
      .toggle { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; padding: 6px 10px; }
      .orb { display: inline-block; width: 28px; height: 28px; border-radius: 50%; background: radial-gradient(circle at 35% 30%, #a7f3d0 0%, #22c55e 35%, #16a34a 65%, #0b1220 100%); box-shadow: 0 0 12px rgba(34,197,94,0.6), inset 0 0 8px rgba(11,93,49,0.6); }
      @keyframes orbPulse { from { box-shadow: 0 0 8px rgba(34,197,94,0.4), inset 0 0 4px rgba(11,93,49,0.4); } to { box-shadow: 0 0 14px rgba(34,197,94,0.8), inset 0 0 8px rgba(11,93,49,0.7); } }
      .orb { animation: orbPulse 2.6s ease-in-out infinite alternate; }

      .feature-analytics { display: grid; gap: 10px; }
      .chart-container { background: #ffffff; border: 1px solid var(--border); border-radius: 10px; padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .chart-container h4 { margin: 0 0 6px; font-size: 14px; }
      .chart-skeleton { height: 160px; border-radius: 8px; background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 37%, #f3f4f6 63%); background-size: 400% 100%; animation: shimmer 1.8s ease-in-out infinite; }
      @keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }
      .chart-canvas { width: 100%; height: 160px; display: block; }
      .dash-grid { display: grid; grid-template-columns: repeat(2, 1fr); grid-auto-rows: 160px; gap: 16px; }
      .chart-card { position: relative; background: #ffffff; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); display: flex; flex-direction: column; transition: opacity 0.3s, transform 0.3s; }
      .card-hd { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--border); }
      .card-title { font-size: 14px; font-weight: 700; cursor: pointer; }
      .card-title:hover { color: #0f766e; }
      .card-ops { display: inline-flex; gap: 8px; align-items: center; }
      .card-upd { position: relative; font-size: 11px; color: var(--muted); }
      .card-upd-pill { border: 0; background: #f1f5f9; color: #64748b; border-radius: 999px; padding: 4px 8px; display: inline-flex; align-items: center; gap: 4px; cursor: pointer; }
      .card-upd-label { font-weight: 500; }
      .card-upd-value { font-variant-numeric: tabular-nums; }
      .card-upd-pop { position: absolute; top: calc(100% + 6px); right: 0; min-width: 180px; padding: 8px 10px; border-radius: 8px; background: #ffffff; border: 1px solid var(--border); box-shadow: 0 8px 16px rgba(0,0,0,0.12); display: none; z-index: 40; }
      .card-upd-pop.open { display: block; }
      .card-upd-row { font-size: 12px; color: #0f172a; }
      .card-upd-row + .card-upd-row { margin-top: 4px; }
      .icon-btn { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; height: 28px; padding: 0 8px; cursor: pointer; }
      .icon-btn:hover { border-color: #cbd5e1; }
      .shape-dd { position: relative; }
      .shape-btn { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; height: 28px; padding: 4px 8px; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
      .shape-menu { position: absolute; top: calc(100% + 6px); right: 0; background: #ffffff; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.12); display: none; padding: 6px; z-index: 20; }
      .shape-menu.open { display: flex; flex-direction: column; gap: 4px; }
      .shape-item { display: inline-flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 8px; cursor: pointer; }
      .shape-item:hover { background: #f8fafc; }
      .shape-ico svg { width: 16px; height: 16px; }
      .drag-over { outline: 2px dashed #14b8a6; outline-offset: -6px; }
      .chart-card.drag-over-top::before,
      .chart-card.drag-over-bottom::after {
        content: "";
        position: absolute;
        left: 8px;
        right: 8px;
        height: 0;
        border-top: 2px solid #14b8a6;
        border-radius: 999px;
        pointer-events: none;
      }
      .chart-card.drag-over-top::before { top: 4px; }
      .chart-card.drag-over-bottom::after { bottom: 4px; }
      .cfg-card { background: #ffffff; border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .cfg-card h3 { margin: 0 0 6px; font-size: 16px; }
      .btn-activate { width: 100%; border: 1px solid #14b8a6; background: #ecfdf5; color: #0f766e; border-radius: 8px; padding: 10px; margin-top: 8px; }
      .chat-list { display: flex; flex-direction: column; gap: 8px; flex: 1; overflow: auto; margin-top: 8px; }
      .chat-msg { display: grid; grid-template-columns: 64px 1fr; gap: 10px; padding: 8px; border: 1px solid var(--border); border-radius: 10px; background: #ffffff; }
      .chat-role { color: var(--muted); }
      .chat-msg code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background: #f3f4f6; border-radius: 4px; padding: 0 4px; }
      .msg-ai { background: #ffffff; }
      .msg-you { background: #f8fafc; }
      #configPanel .bd { display: flex; flex-direction: column; width: 100%; box-sizing: border-box; }
      .chat-box { display: flex; flex-direction: column; flex: 1; width: 100%; box-sizing: border-box; }
      .chat-compose { display: flex; flex-direction: column; gap: 10px; margin-top: auto; padding: 8px; background: #f8fafc; border-top: 1px solid var(--border); position: relative; width: 100%; box-sizing: border-box; }
      .chat-input { width: 100%; border: 1px solid var(--border); border-radius: 10px; background: #ffffff; color: var(--text); padding: 13px 14px; min-height: 96px; resize: vertical; }
      .chat-send { border: 1px solid #14b8a6; background: #ecfdf5; color: #0f766e; border-radius: 8px; padding: 10px; }
      .spin { width: 14px; height: 14px; border: 2px solid #e5e7eb; border-top-color: #a7f3d0; border-right-color: #a7f3d0; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; margin-right: 6px; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .chat-result-card { display: flex; flex-direction: column; gap: 6px; border: 1px solid var(--border); border-radius: 10px; background: #ffffff; padding: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .chat-result-card .res-title { font-weight: 700; }
      .chat-result-card .res-meta { color: var(--muted); font-size: 12px; }
      .chat-result-card .res-actions { display: flex; align-items: center; gap: 8px; }
      .chat-result-card .btn-view { border: 1px solid var(--border); background: #f8fafc; color: var(--text); border-radius: 8px; padding: 6px 10px; cursor: pointer; }
      .res-thumb { border: 1px dashed var(--border); border-radius: 8px; padding: 6px; background: #f8fafc; }
      .res-thumb-canvas { width: 100%; height: 42px; display: block; }
      .chat-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
      .mode-dd { position: relative; }
      .mode-btn { display: inline-flex; align-items: center; gap: 6px; border: 1px solid var(--border); background: #f8fafc; color: var(--text); border-radius: 8px; padding: 6px 10px; cursor: pointer; }
      .mode-ico svg { width: 14px; height: 14px; }
      .mode-menu { position: absolute; top: calc(100% + 6px); left: 0; background: #ffffff; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.12); display: none; padding: 6px; z-index: 30; }
      .mode-menu.open { display: grid; grid-template-columns: 1fr; gap: 6px; }
      .mode-item { display: inline-flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 8px; cursor: pointer; }
      .mode-item:hover { background: #f8fafc; }
      .at-btn { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; padding: 6px 8px; cursor: pointer; }
      .mention-menu { position: absolute; left: 8px; min-width: 240px; background: #ffffff; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.12); display: none; z-index: 40; }
      .mention-menu.open { display: block; }
      .mention-list { display: flex; flex-direction: column; gap: 4px; padding: 6px; max-height: 240px; overflow: auto; }
      .mention-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 6px; cursor: pointer; }
      .mention-item:hover { background: #f8fafc; }

      .add-card { display: flex; align-items: center; justify-content: center; border: 1px dashed var(--border); border-radius: 12px; background: #f9fafb; cursor: pointer; }
      .add-card-btn { border: 0; background: transparent; padding: 18px 10px; display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; color: #0f766e; }
      .add-card-plus { width: 40px; height: 40px; border-radius: 999px; border: 1px dashed #0f766e; display: flex; align-items: center; justify-content: center; font-size: 24px; line-height: 1; }
      .add-card-label { font-size: 12px; color: var(--muted); }
      .mini-chat { position: absolute; width: 260px; border-radius: 12px; background: #ffffff; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(15,23,42,0.25); display: none; flex-direction: column; z-index: 80; }
      .mini-chat.open { display: flex; }
      .mini-chat-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 600; }
      .mini-chat-close { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 6px; padding: 2px 6px; font-size: 12px; cursor: pointer; }
      .mini-chat-body { padding: 8px 10px; display: flex; flex-direction: column; gap: 6px; }
      .mini-chat-input { width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 6px 8px; font-size: 12px; resize: vertical; min-height: 56px; }
      .mini-chat-send { align-self: flex-end; border: 1px solid #14b8a6; background: #ecfdf5; color: #0f766e; border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
      .mini-chat-hint { padding: 0 10px 8px; font-size: 11px; color: var(--muted); }

      .nav-popover { position: fixed; top: 70px; left: 260px; width: 380px; border-radius: 12px; background: #ffffff; border: 1px solid var(--border); box-shadow: 0 16px 40px rgba(0,0,0,0.12); display: none; z-index: 900; }
      .nav-popover.open { display: block; }
      .nav-popover .pop-hd { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); font-weight: 700; }
      .nav-popover .pop-bd { padding: 12px 14px; }
      .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
      .action-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 10px; padding: 14px 8px; cursor: pointer; text-decoration: none; }
      .action-btn:hover { border-color: #cbd5e1; }
      .action-btn.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
      .act-ico { width: 30px; height: 30px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; }
      .act-ico svg { width: 18px; height: 18px; }
      .ico-orange { background: #5a3a0b; }
      .ico-green { background: #0b3a2a; }
      .ico-purple { background: #3a0b55; }
      .label { font-size: 13px; color: #374151; font-weight: 600; }
      .popover-close { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; padding: 6px 10px; }
      body.sidebar-collapsed .nav-popover { left: 60px; }

      .search-overlay { position: fixed; inset: 0; background: rgba(2,8,23,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
      .search-overlay.open { display: flex; }
      .search-modal { width: min(760px, 92vw); border-radius: 12px; background: #ffffff; border: 1px solid var(--border); box-shadow: 0 12px 32px rgba(0,0,0,0.12); }
      .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); }
      .modal-title { font-weight: 700; }
      .modal-close { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; padding: 6px 10px; }
      .modal-body { padding: 12px 14px; }
      .modal-input { width: 100%; border: 1px solid var(--border); border-radius: 10px; background: #ffffff; color: #111827; padding: 10px 12px; margin-bottom: 12px; }
      .entity-list { display: flex; flex-direction: column; gap: 6px; max-height: 60vh; overflow: auto; }
      .entity-row { display: grid; grid-template-columns: 80px 1fr 90px 100px; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; }
      .entity-row:hover { background: #f8fafc; }
      .sym { font-weight: 600; letter-spacing: 0.4px; }
      .type { color: var(--muted); font-size: 12px; }
      .exch { color: #a7f3d0; font-size: 12px; }
      .detail-page { display: none; }
      .detail-page.open { display: block; }
      .detail-modal { max-width: 960px; margin: 0 auto; padding: 12px 0 16px; display: flex; flex-direction: column; gap: 12px; }
      .detail-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 0 2px; }
      .detail-header-left { display: flex; flex-direction: column; gap: 4px; }
      .detail-header-actions { display: flex; align-items: center; gap: 8px; }
      .detail-action-btn { border-radius: 8px; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); transition: all 0.2s ease; }
      .detail-action-btn-primary { background: #14b8a6; color: #ffffff; border-color: #14b8a6; }
      .detail-action-btn-primary:hover { background: #0f766e; border-color: #0f766e; }
      .detail-action-btn-secondary { background: #ffffff; color: #374151; border-color: var(--border); }
      .detail-action-btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }
      .detail-action-icon-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #ffffff;
        color: #374151;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        padding: 0;
      }
      .detail-action-icon-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
      }
      .detail-action-icon-btn svg {
        width: 18px;
        height: 18px;
      }
      .detail-breadcrumb { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
      .detail-breadcrumb-back { border: 0; background: transparent; color: #0f766e; padding: 0; cursor: pointer; font-size: 12px; }
      .detail-breadcrumb-back:hover { text-decoration: underline; }
      .detail-breadcrumb-current { color: #0f172a; font-weight: 500; }
      .detail-title { font-size: 18px; font-weight: 700; }
      .detail-subtitle { font-size: 13px; color: var(--muted); display: flex; align-items: center; gap: 6px; margin-top: 2px; }
      .detail-subtitle-book-icon { display: inline-flex; align-items: center; width: 14px; height: 14px; flex-shrink: 0; opacity: 0.7; }
      .detail-version-badge { display: inline-flex; align-items: center; padding: 2px 6px; background: #f3f4f6; color: #6b7280; border-radius: 4px; font-size: 11px; font-weight: 600; font-variant-numeric: tabular-nums; margin-left: 2px; }
      .detail-status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #22c55e; margin-left: 4px; flex-shrink: 0; box-shadow: 0 0 0 2px rgba(34,197,94,0.2); animation: statusPulse 2s ease-in-out infinite; }
      @keyframes statusPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
      .detail-meta { margin-top: 4px; padding: 8px 0 0; display: flex; flex-wrap: wrap; gap: 6px 16px; font-size: 12px; color: var(--muted); border-top: 1px solid var(--border); }
      .detail-meta-item span:first-child { margin-right: 4px; color: #6b7280; }
      .detail-meta-clickable { position: relative; cursor: pointer; color: #0f766e; display: flex; align-items: center; gap: 5px; }
      .detail-meta-clickable:hover { color: #14b8a6; }
      .detail-meta-icon { width: 14px; height: 14px; flex-shrink: 0; opacity: 0.8; }
      .detail-meta-clickable:hover .detail-meta-icon { opacity: 1; }
      .detail-meta-popover { position: absolute; top: calc(100% + 8px); left: 0; min-width: 280px; max-width: 400px; background: #ffffff; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.12); display: none; z-index: 50; }
      .detail-meta-popover.open { display: block; }
      .detail-meta-popover-header { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 600; color: #0f172a; }
      .detail-meta-popover-list { max-height: 300px; overflow-y: auto; padding: 6px; }
      .detail-meta-popover-item { padding: 8px 10px; border-radius: 6px; font-size: 12px; color: #0f172a; cursor: pointer; }
      .detail-meta-popover-item:hover { background: #f8fafc; }
      .detail-body { margin-top: 10px; display: flex; align-items: flex-start; gap: 16px; }
      .detail-main { flex: 1; display: flex; flex-direction: column; gap: 12px; }
      .detail-chart-wrap { border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: #f8fafc; }
      .detail-chart { width: 100%; height: 220px; display: block; }
      .detail-logic-card { border-radius: 10px; border: 1px solid var(--border); padding: 10px 12px; background: #f9fafb; display: flex; flex-direction: column; gap: 6px; }
      .detail-logic-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 4px; }
      .detail-logic-title { font-size: 13px; font-weight: 600; }
      .detail-desc { font-size: 13px; color: #0f172a; line-height: 1.6; display: flex; flex-direction: column; gap: 4px; }
      .detail-desc-main { display: flex; align-items: flex-start; gap: 8px; }
      .detail-content-view { margin: 0; width: 100%; }
      .detail-content-view code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background: #e5e7eb; border: 1px solid #d1d5db; border-radius: 4px; padding: 3px 8px; color: #111827; font-weight: 500; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: inline-block; }
      .detail-content-view code span { display: inline-flex; align-items: center; white-space: nowrap; }
      #detailCodeText { background: #1e293b; color: #e2e8f0; border-radius: 6px; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; line-height: 1.6; overflow-x: auto; margin: 0; width: 100%; box-sizing: border-box; }
      #detailCodeText code { background: transparent; color: inherit; padding: 0; font-size: inherit; display: block; width: 100%; white-space: pre; }
      .detail-view-toggle { display: inline-flex; border: 1px solid var(--border); border-radius: 6px; background: #ffffff; padding: 2px; gap: 2px; }
      .detail-view-toggle-btn { border: 0; background: transparent; color: #6b7280; border-radius: 4px; padding: 4px 10px; font-size: 12px; cursor: pointer; transition: all 0.2s ease; }
      .detail-view-toggle-btn:hover { background: #f8fafc; color: #374151; }
      .detail-view-toggle-btn.active { background: #f3f4f6; color: #0f172a; font-weight: 600; }
      .detail-table-wrap { border-radius: 10px; border: 1px solid var(--border); padding: 10px 12px; background: #ffffff; }
      .detail-table-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
      .detail-table-title { font-size: 13px; font-weight: 600; }
      .detail-download { border: 1px solid var(--border); background: #f8fafc; color: #111827; border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
      .detail-table { width: 100%; border-collapse: collapse; font-size: 12px; max-height: 220px; overflow: auto; display: block; }
      .detail-table thead, .detail-table tbody { display: block; }
      .detail-table tbody { max-height: 220px; overflow-y: auto; }
      .detail-table tr { display: grid; grid-template-columns: 1fr 1fr; }
      .detail-table th, .detail-table td { border: 1px solid #e5e7eb; padding: 4px 6px; text-align: right; }
      .detail-table th:first-child, .detail-table td:first-child { text-align: left; }
      .detail-close { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; padding: 4px 8px; font-size: 12px; cursor: pointer; }
      .detail-ds-btn { border: 1px solid #e5e7eb; background: #f3f4f6; color: #4b5563; border-radius: 6px; padding: 0; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
      .detail-ds-icon { font-size: 11px; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
      .detail-datasource-sidebar { width: 280px; border-radius: 12px; border: 1px solid var(--border); background: #f9fafb; padding: 10px 12px; display: none; flex-direction: column; gap: 8px; }
      .detail-datasource-sidebar.open { display: flex; }
      .detail-ds-header { display: flex; align-items: center; justify-content: space-between; }
      .detail-ds-title { font-size: 13px; font-weight: 600; }
      .detail-ds-close { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; padding: 2px 8px; font-size: 12px; cursor: pointer; }
      .detail-ds-body { font-size: 12px; color: #0f172a; line-height: 1.5; }

      /* Error/Warning state styles for cards */
      .card-error { border-color: #fecaca; background: linear-gradient(180deg, #fef2f2 0%, #ffffff 100%); }
      .card-error .card-hd { border-bottom-color: #fecaca; }
      .card-upd-pill-error { background: #fef2f2 !important; color: #dc2626 !important; border: 1px solid #fecaca !important; }
      .card-error-icon { display: inline-flex; align-items: center; width: 14px; height: 14px; color: #dc2626; }
      .card-error-icon svg { width: 14px; height: 14px; }
      
      /* Detail page error status */
      .detail-status-dot-error { background: #dc2626 !important; box-shadow: 0 0 0 2px rgba(220,38,38,0.2) !important; }
      .detail-error-banner { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; margin-top: 8px; font-size: 13px; color: #dc2626; transition: all 0.3s; }
      .detail-error-banner.success { background: #f0fdf4; border-color: #bbf7d0; color: #16a34a; }
      .detail-error-banner svg { width: 16px; height: 16px; flex-shrink: 0; }
      .detail-error-banner span { flex: 1; }
      .detail-upgrade-btn { border: 1px solid #dc2626; background: #ffffff; color: #dc2626; border-radius: 6px; padding: 4px 12px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-left: auto; position: relative; min-width: 80px; }
      .detail-upgrade-btn:hover:not(:disabled) { background: #fee2e2; border-color: #b91c1c; color: #b91c1c; }
      .detail-upgrade-btn:disabled { opacity: 0.7; cursor: not-allowed; }
      .detail-upgrade-btn.loading { color: transparent; }
      .detail-upgrade-btn.loading::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 14px; height: 14px; border: 2px solid #dc2626; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
      .detail-delete-btn { border: 1px solid #dc2626; background: #dc2626; color: #ffffff; border-radius: 6px; padding: 4px 12px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-left: auto; }
      .detail-delete-btn:hover { background: #b91c1c; border-color: #b91c1c; }
    </style>
  </head>
  <body class="has-chat-panel">
    <aside></aside>
    <aside class="subnav">
      <div class="subnav-header"><div class="subnav-title">More</div><button class="subnav-close" type="button">Close</button></div>
      <div id="subnav-content" class="subnav-content"></div>
    </aside>
    <div id="searchOverlay" class="search-overlay">
      <div class="search-modal">
        <div class="modal-header"><div class="modal-title">Search</div><button id="searchClose" class="modal-close">X</button></div>
        <div class="modal-body"><input id="searchInput" class="modal-input" placeholder="Try symbol, e.g. AAPL" /><div id="entityList" class="entity-list"></div></div>
      </div>
    </div>
    <div id="navPopover" class="nav-popover" role="dialog" aria-label="New Playbook">
      <div class="pop-hd"><div>New Playbook</div><button id="popoverClose" class="popover-close">Close</button></div>
      <div class="pop-bd">
        <div class="action-grid">
          <a href="#" class="action-btn" data-act="dashboard"><span class="act-ico ico-orange"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#f59e0b" d="M3 3h8v8H3V3zm10 0h8v5h-8V3zm0 7h8v11h-8V10zm-10 4h8v7H3v-7z"/></svg></span><span class="label">Dashboard</span></a>
          <a href="#" class="action-btn disabled" data-act="strategy" aria-disabled="true" tabindex="-1"><span class="act-ico ico-green"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#34d399" d="M12 2l4 8H8l4-8zm-6 18h12v2H6v-2zm1-8h10v2H7v-2z"/></svg></span><span class="label">Trading Strategy</span></a>
          <a href="#" class="action-btn disabled" data-act="research" aria-disabled="true" tabindex="-1"><span class="act-ico ico-purple"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#a78bfa" d="M12 3l9 4-9 4-9-4 9-4zm0 6l9 4-9 4-9-4 9-4zm0 8l9 4-9 4-9-4 9-4z"/></svg></span><span class="label">Agentic Research</span></a>
        </div>
      </div>
    </div>
    <main>
      <div id="dashboardView">
        <section id="dashPanel" class="paper">
          <div class="hd">
            <div class="hd-row">
              <div class="hd-left">
                <div class="hd-avatar">
                  <img src="https://api.dicebear.com/7.x/fun-emoji/svg?seed=yllygg" alt="avatar">
                </div>
                <span class="hd-user">YLLYGG</span>
                <span class="hd-sep">·</span>
                <span class="hd-trend-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                  </svg>
                </span>
                <span class="hd-title">Attribution Analysis Strategy for Price Trends</span>
                <span class="hd-status"></span>
              </div>
              <div class="hd-actions">
                <button id="editHistoryBtn" class="hd-action-btn" title="Edit History">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                </button>
                <div id="editHistoryPanel" class="edit-history-panel">
                  <div class="edit-history-body" id="editHistoryBody">
                    <!-- History items will be injected here -->
                  </div>
                </div>
                <div class="share-dd">
                  <button id="shareBtn" class="hd-action-btn" title="Share">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="18" cy="5" r="3"></circle>
                      <circle cx="6" cy="12" r="3"></circle>
                      <circle cx="18" cy="19" r="3"></circle>
                      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                  </button>
                  <div id="sharePanel" class="share-panel">
                    <div class="share-header">
                      <div class="share-title">Share Playbook</div>
                      <button id="shareClose" class="share-close">×</button>
                    </div>
                    <div class="share-body">
                      <div class="share-visibility">
                        <div class="share-visibility-label">Visibility</div>
                        <div class="share-toggle">
                          <label class="share-toggle-switch">
                            <input type="checkbox" id="shareVisibilityToggle" checked>
                            <span class="share-toggle-slider"></span>
                          </label>
                          <span class="share-toggle-label" id="shareVisibilityLabel">Public</span>
                        </div>
                      </div>
                      <div class="share-url-section" id="shareUrlSection">
                        <div class="share-url-label">Share URL</div>
                        <div class="share-url-input-group">
                          <input type="text" id="shareUrlInput" class="share-url-input" readonly value="https://alva.xyz/playbook/attribution-analysis-strategy">
                          <button id="shareCopyBtn" class="share-copy-btn">Copy</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <button class="hd-action-btn" title="Star">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                  </svg>
                </button>
                <button class="hd-action-btn-text" title="Release">Release</button>
              </div>
            </div>
          </div>
          <div class="bd">
            <div id="dashGrid" class="dash-grid">
              <div class="chart-card" id="chart-btc-ma25-prev" data-w="1" data-h="1" draggable="true">
                <div class="card-hd">
                  <div class="card-title" onclick="openChartDetail('chart-btc-ma25-prev')">Btc Ma25 Prev</div>
                  <div class="card-ops">
                    <div class="card-upd" data-updated="2025-12-06 10:24" data-interval="1w">
                      <button class="card-upd-pill" type="button">
                        <span class="card-upd-label">Last</span>
                        <span class="card-upd-value">12/6 10:24</span>
                      </button>
                      <div class="card-upd-pop">
                        <div class="card-upd-row card-upd-time"></div>
                        <div class="card-upd-row card-upd-interval"></div>
                      </div>
                    </div>
                    <div class="shape-dd">
                      <button class="shape-btn" aria-label="Widget size"><span class="shape-ico" data-cur="sq-s"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg></span></button>
                      <div class="shape-menu">
                        <button class="shape-item" data-size="sq-s"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="4" y="4" width="8" height="8" fill="#9ca3af"/></svg></span><span>1×1</span></button>
                        <button class="shape-item" data-size="sq-l"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg></span><span>2×2</span></button>
                        <button class="shape-item" data-size="rect-h"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="2" y="4" width="12" height="8" fill="#9ca3af"/></svg></span><span>2×1</span></button>
                        <button class="shape-item" data-size="rect-v"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="4" y="2" width="8" height="12" fill="#9ca3af"/></svg></span><span>1×2</span></button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chart-container"><div class="chart-skeleton"></div></div>
              </div>
              <div class="chart-card" data-w="1" data-h="1" draggable="true">
                <div class="card-hd">
                  <div class="card-title">Btc Ma25 W</div>
                  <div class="card-ops">
                    <div class="card-upd" data-updated="2025-12-06 10:30" data-interval="1w">
                      <button class="card-upd-pill" type="button">
                        <span class="card-upd-label">Last</span>
                        <span class="card-upd-value">12/6 10:30</span>
                      </button>
                      <div class="card-upd-pop">
                        <div class="card-upd-row card-upd-time"></div>
                        <div class="card-upd-row card-upd-interval"></div>
                      </div>
                    </div>
                    <div class="shape-dd">
                      <button class="shape-btn" aria-label="Widget size"><span class="shape-ico" data-cur="sq-s"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg></span></button>
                      <div class="shape-menu">
                        <button class="shape-item" data-size="sq-s"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="4" y="4" width="8" height="8" fill="#9ca3af"/></svg></span><span>1×1</span></button>
                        <button class="shape-item" data-size="sq-l"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg></span><span>2×2</span></button>
                        <button class="shape-item" data-size="rect-h"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="2" y="4" width="12" height="8" fill="#9ca3af"/></svg></span><span>2×1</span></button>
                        <button class="shape-item" data-size="rect-v"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="4" y="2" width="8" height="12" fill="#9ca3af"/></svg></span><span>1×2</span></button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chart-container"><div class="chart-skeleton"></div></div>
              </div>
              <div class="chart-card card-error" id="chart-eth-funding-rate" data-w="1" data-h="1" draggable="true">
                <div class="card-hd">
                  <div class="card-title" onclick="openChartDetail('chart-eth-funding-rate')">ETH Funding Rate</div>
                  <div class="card-ops">
                    <div class="card-upd card-upd-error" data-updated="2025-01-15 08:30" data-interval="8h" data-error="true" data-error-msg="Source playbook has a breaking change. Upgrade required to continue." data-error-type="breaking-change">
                      <button class="card-upd-pill card-upd-pill-error" type="button">
                        <span class="card-error-icon">
                          <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 1L15 14H1L8 1Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <path d="M8 6v4M8 11.5v.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                          </svg>
                        </span>
                        <span class="card-upd-label">Paused</span>
                      </button>
                      <div class="card-upd-pop">
                        <div class="card-upd-row card-upd-time"></div>
                        <div class="card-upd-row card-upd-interval"></div>
                        <div class="card-upd-row card-upd-error-msg" style="color: #dc2626; margin-top: 4px;"></div>
                      </div>
                    </div>
                    <div class="shape-dd">
                      <button class="shape-btn" aria-label="Widget size"><span class="shape-ico" data-cur="sq-s"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg></span></button>
                      <div class="shape-menu">
                        <button class="shape-item" data-size="sq-s"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="4" y="4" width="8" height="8" fill="#9ca3af"/></svg></span><span>1×1</span></button>
                        <button class="shape-item" data-size="sq-l"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg></span><span>2×2</span></button>
                        <button class="shape-item" data-size="rect-h"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="2" y="4" width="12" height="8" fill="#9ca3af"/></svg></span><span>2×1</span></button>
                        <button class="shape-item" data-size="rect-v"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="4" y="2" width="8" height="12" fill="#9ca3af"/></svg></span><span>1×2</span></button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chart-container"><div class="chart-skeleton"></div></div>
              </div>
              <div class="chart-card card-error card-archived" id="chart-sol-rsi" data-w="1" data-h="1" draggable="true">
                <div class="card-hd">
                  <div class="card-title" onclick="openChartDetail('chart-sol-rsi')">SOL RSI</div>
                  <div class="card-ops">
                    <div class="card-upd card-upd-error" data-updated="2025-01-10 14:20" data-interval="4h" data-error="true" data-error-msg="Source playbook no longer maintains this data stream. Widget archived." data-error-type="archived">
                      <button class="card-upd-pill card-upd-pill-error" type="button">
                        <span class="card-error-icon">
                          <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 1L15 14H1L8 1Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                            <path d="M8 6v4M8 11.5v.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                          </svg>
                        </span>
                        <span class="card-upd-label">Archived</span>
                      </button>
                      <div class="card-upd-pop">
                        <div class="card-upd-row card-upd-time"></div>
                        <div class="card-upd-row card-upd-interval"></div>
                        <div class="card-upd-row card-upd-error-msg" style="color: #dc2626; margin-top: 4px;"></div>
                      </div>
                    </div>
                    <div class="shape-dd">
                      <button class="shape-btn" aria-label="Widget size"><span class="shape-ico" data-cur="sq-s"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg></span></button>
                      <div class="shape-menu">
                        <button class="shape-item" data-size="sq-s"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="4" y="4" width="8" height="8" fill="#9ca3af"/></svg></span><span>1×1</span></button>
                        <button class="shape-item" data-size="sq-l"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg></span><span>2×2</span></button>
                        <button class="shape-item" data-size="rect-h"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="2" y="4" width="12" height="8" fill="#9ca3af"/></svg></span><span>2×1</span></button>
                        <button class="shape-item" data-size="rect-v"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="4" y="2" width="8" height="12" fill="#9ca3af"/></svg></span><span>1×2</span></button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="chart-container"><div class="chart-skeleton"></div></div>
              </div>
              <div class="chart-card add-card" data-w="1" data-h="1">
                <button id="miniChatBtn" class="add-card-btn" type="button">
                  <div class="add-card-plus">+</div>
                  <div class="add-card-label">New widget</div>
                </button>
              </div>
            </div>
          </div>
          <div id="miniChat" class="mini-chat">
            <div class="mini-chat-header">
              <div class="mini-chat-title">Quick chart chat</div>
              <button id="miniChatClose" class="mini-chat-close" type="button">X</button>
            </div>
            <div class="mini-chat-body">
              <textarea id="miniChatInput" class="mini-chat-input" placeholder="比如：add chart BTC MA25" rows="2"></textarea>
              <button id="miniChatSend" class="mini-chat-send" type="button">Send</button>
            </div>
            <div class="mini-chat-hint">支持「add chart xxx」或「新增图表 xxx」指令</div>
          </div>
        </section>
      </div>
      <div id="chartDetailOverlay" class="detail-page">
        <div class="detail-modal">
          <div class="detail-header">
            <div class="detail-header-left">
              <div id="detailTitle" class="detail-title"></div>
              <div id="detailSubtitle" class="detail-subtitle"></div>
            </div>
            <div class="detail-header-actions">
              <button id="detailSaveBtn" class="detail-action-icon-btn" type="button" title="Save to Library" aria-label="Save to Library">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 4h10a1 1 0 0 1 1 1v14l-6-3-6 3V5a1 1 0 0 1 1-1z"/>
                </svg>
              </button>
              <button id="detailUseBtn" class="detail-action-btn detail-action-btn-secondary" type="button" title="Use creates a live reference in your Playbook.">Use</button>
              <button id="detailRemixBtn" class="detail-action-btn detail-action-btn-primary" type="button" title="Remix creates an editable copy. No live dependency.">Remix</button>
            </div>
          </div>
          <div class="detail-meta">
            <div class="detail-meta-item detail-meta-clickable" id="detailReferences">
              <svg class="detail-meta-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 8h8M8 4v8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/><circle cx="8" cy="8" r="5.5" stroke="currentColor" stroke-width="1.2" fill="none"/><path d="M6 6l4 4M10 6l-4 4" stroke="currentColor" stroke-width="1" stroke-linecap="round"/></svg>
              <span id="detailReferencesCount">17</span> <span>References</span>
              <div class="detail-meta-popover" id="referencesPopover">
                <div class="detail-meta-popover-header">Referenced by Playbooks</div>
                <div class="detail-meta-popover-list" id="referencesList"></div>
              </div>
            </div>
            <div class="detail-meta-item detail-meta-clickable" id="detailRemixs">
              <svg class="detail-meta-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 4C2.5 4 5 2 8 6C8 6 11 10 13.5 8" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.5 12C2.5 12 5 14 8 10C8 10 11 6 13.5 8" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><polygon points="13.5,8 14.8,8.8 13.5,9.6" fill="currentColor"/><polygon points="13.5,8 14.8,7.2 13.5,6.4" fill="currentColor"/></svg>
              <span id="detailRemixsCount">42</span> <span>Remixs</span>
              <div class="detail-meta-popover" id="remixsPopover">
                <div class="detail-meta-popover-header">Remix Records</div>
                <div class="detail-meta-popover-list" id="remixsList"></div>
              </div>
            </div>
            <div class="detail-meta-item"><span>Created at</span><span id="detailCreated"></span></div>
            <div class="detail-meta-item"><span>Last updated</span><span id="detailUpdated"></span></div>
            <div class="detail-meta-item"><span>Refresh interval</span><span id="detailInterval"></span></div>
          </div>
          <div class="detail-body">
            <div class="detail-main">
              <div class="detail-chart-wrap">
                <canvas id="detailChartCanvas" class="detail-chart"></canvas>
              </div>
              <div class="detail-logic-card">
                <div class="detail-logic-header">
                  <div class="detail-logic-title">Logic</div>
                  <div class="detail-view-toggle">
                    <button class="detail-view-toggle-btn active" data-view="idea" type="button" aria-label="Idea view">
                      <span>Idea</span>
                    </button>
                    <button class="detail-view-toggle-btn" data-view="code" type="button" aria-label="Code view">
                      <span>Code</span>
                    </button>
                  </div>
                </div>
                <div id="detailDesc" class="detail-desc">
                  <div class="detail-desc-main">
                    <p id="detailLogicText" class="detail-content-view"></p>
                    <pre id="detailCodeText" class="detail-content-view" style="display: none;"><code id="detailCodeContent"></code></pre>
                  </div>
                </div>
              </div>
              <div class="detail-table-wrap">
                <div class="detail-table-head">
                  <div class="detail-table-title">Data table</div>
                  <button id="detailDownload" class="detail-download" type="button">Download CSV</button>
                </div>
                <table class="detail-table">
                  <thead>
                    <tr><th>Index</th><th>Value</th></tr>
                  </thead>
                  <tbody id="detailTableBody"></tbody>
                </table>
              </div>
            </div>
            <aside id="detailDatasourceSidebar" class="detail-datasource-sidebar">
              <div class="detail-ds-header">
                <div class="detail-ds-title">Datasource</div>
                <button id="detailDatasourceClose" class="detail-ds-close" type="button">Close</button>
              </div>
              <div id="detailDatasourceContent" class="detail-ds-body"></div>
            </aside>
          </div>
        </div>
      </div>
    </main>
    <div id="configPanel" class="chat-panel">
      <div class="hd"><div class="title">chat</div><div><button id="panelToggle" class="toggle">▾</button></div></div>
      <div class="bd">
        <div class="chat-box">
          <div id="cfgChatList" class="chat-list"></div>
          <div class="chat-compose">
            <div class="chat-input-card">
              <textarea id="cfgChatInput" class="chat-textarea" placeholder="Build an investing playbook from your ideas"></textarea>
              <div id="mentionChipsContainer" class="mention-chips-container"></div>
              <div id="mentionMenu" class="mention-menu"><div class="mention-list"></div></div>
              <div id="addContextMenu" class="add-context-menu">
                <div class="add-context-header">Add Context</div>
                <div class="add-context-body" id="addContextBody"></div>
              </div>
              <div class="chat-toolbar">
                <div class="build-btn-dd">
                  <button id="buildModeBtn" class="build-btn" type="button" data-mode="build">
                    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                      <path d="M2 12h12v2H2v-2zm0-8h2v6H2V4zm4 2h2v4H6V6zm4-4h2v8h-2V2z" fill="currentColor"/>
                    </svg>
                    Build
                    <span>▾</span>
                  </button>
                  <div id="buildMenu" class="build-menu">
                    <button class="build-menu-item" data-mode="ask">
                      <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 2a6 6 0 100 12A6 6 0 008 2zm0 1a5 5 0 110 10A5 5 0 008 3zm0 2a3 3 0 100 6 3 3 0 000-6zm0 1a2 2 0 110 4 2 2 0 010-4z" fill="currentColor"/>
                      </svg>
                      Ask
                    </button>
                    <button class="build-menu-item active" data-mode="build">
                      <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 12h12v2H2v-2zm0-8h2v6H2V4zm4 2h2v4H6V6zm4-4h2v8h-2V2z" fill="currentColor"/>
                      </svg>
                      Build
                    </button>
                  </div>
                </div>
                <div class="toolbar-right">
                  <button id="chatAtBtn" class="toolbar-icon-btn" type="button" aria-label="Mention">@</button>
                  <button class="toolbar-icon-btn" type="button" aria-label="Upload image">
                    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                      <rect x="2" y="4" width="12" height="8" fill="none" stroke="currentColor" stroke-width="1"/>
                      <path d="M4 10l2-2 2 2 4-4 2 2v2H4z" fill="currentColor" opacity="0.6"/>
                      <circle cx="5" cy="6" r="0.8" fill="currentColor"/>
                    </svg>
                  </button>
                  <button id="cfgChatSend" class="toolbar-icon-btn send-btn" type="button" aria-label="Send">
                    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                      <path d="M2 8l12-6-6 6 6 6L2 8z" fill="currentColor"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="nav.js"></script>
    <script src="chat-panel.js"></script>
    <script>
      const charts = [];
      const chartDetails = new Map();
      function applyLayout() {
        document.querySelectorAll('#dashGrid .chart-card').forEach(card => {
          const w = parseInt(card.dataset.w || '6', 10);
          const h = parseInt(card.dataset.h || '1', 10);
          card.style.gridColumn = `span ${w}`;
          card.style.gridRow = `span ${h}`;
        });
      }
      function calcCanvasHeight(cv) {
        try {
          const container = cv.parentElement;
          const card = container.closest('.chart-card');
          if (!card) {
            const dh = parseInt(cv.dataset.h || 160, 10);
            return dh;
          }
          const header = card ? card.querySelector('.card-hd') : null;
          const cardRect = card ? card.getBoundingClientRect() : { height: 160 };
          const headerRect = header ? header.getBoundingClientRect() : { height: 0 };
          const cs = container ? getComputedStyle(container) : { paddingTop: '0', paddingBottom: '0' };
          const paddingV = parseFloat(cs.paddingTop || '0') + parseFloat(cs.paddingBottom || '0');
          const available = Math.max(100, Math.floor(cardRect.height - headerRect.height - paddingV));
          return available;
        } catch { return parseInt(cv.dataset.h || 160, 10); }
      }
      function drawLineChart(cv, data, color) {
        const ctx = cv.getContext('2d');
        const ratio = window.devicePixelRatio || 1;
        const w = cv.parentElement.clientWidth || 600;
        const h = calcCanvasHeight(cv);
        cv.width = w * ratio;
        cv.height = h * ratio;
        cv.style.width = '100%';
        cv.style.height = h + 'px';
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
        ctx.clearRect(0, 0, w, h);
        if (!data || !data.length) return;
        let min = Math.min.apply(null, data);
        let max = Math.max.apply(null, data);
        if (min === max) { min -= 1; max += 1; }
        const pad = 10;
        const xStep = (w - pad * 2) / (data.length - 1);
        ctx.lineWidth = 2;
        ctx.strokeStyle = color || '#22c55e';
        ctx.beginPath();
        data.forEach((v, i) => {
          const x = pad + xStep * i;
          const y = pad + (h - pad * 2) * (1 - (v - min) / (max - min));
          if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }
      function setupCharts() {
        document.querySelectorAll('#dashGrid .chart-container .chart-skeleton').forEach((skel, idx) => {
          const canvas = document.createElement('canvas');
          canvas.className = 'chart-canvas';
          canvas.dataset.h = '160';
          skel.replaceWith(canvas);
          const card = canvas.closest('.chart-card');
          const cardId = card ? card.id : '';
          
          // Special handling for error state cards
          let series, color;
          if (cardId === 'chart-eth-funding-rate') {
            // ETH Funding Rate data (oscillating around 0)
            series = [0.012, 0.008, 0.015, 0.010, 0.006, 0.018, 0.014, 0.009, 0.011, 0.007, 0.013, 0.016];
            color = '#dc2626'; // Red to indicate error state
          } else if (cardId === 'chart-sol-rsi') {
            // SOL RSI data (RSI typically ranges 0-100)
            series = [45, 48, 52, 55, 58, 62, 65, 68, 72, 75, 78, 82];
            color = '#dc2626'; // Red to indicate archived state
          } else {
            series = idx % 2 === 0 ? [30,32,31,35,34,36,38,37,39,41,40,42] : [12,11,13,12,14,13,15,16,15,17,18,17];
            color = idx % 2 === 0 ? '#7c3aed' : '#f59e0b';
          }
          
          if (card) {
            if (!card.id) card.id = 'chart-' + (idx + 1);
            const titleEl = card.querySelector('.card-title');
            const title = titleEl ? titleEl.textContent.trim() : 'Chart';
            const updEl = card.querySelector('.card-upd');
            const updated = updEl ? updEl.getAttribute('data-updated') || '' : '';
            const interval = updEl ? updEl.getAttribute('data-interval') || '' : '';
            const isError = updEl ? updEl.getAttribute('data-error') === 'true' : false;
            const errorMsg = updEl ? updEl.getAttribute('data-error-msg') || '' : '';
            const errorType = updEl ? updEl.getAttribute('data-error-type') || '' : '';
            chartDetails.set(card.id, {
              id: card.id,
              title,
              author: '@Sheer',
              created: updated || '2025-12-06 10:00',
              updated,
              interval,
              series,
              color,
              isError,
              errorMsg,
              errorType,
              version: 'V1'
            });
          }
          charts.push(() => drawLineChart(canvas, series, color));
        });
        charts.forEach(fn => fn());
      }
      function genSeries() {
        return Array.from({length: 16}, (_, i) => 50 + Math.sin(i / 2.2) * 8 + (i % 4) - (i % 5) * 0.6);
      }
      function initCardUpdate(card) {
        const upd = card.querySelector('.card-upd');
        if (!upd) return;
        const pop = upd.querySelector('.card-upd-pop');
        const pill = upd.querySelector('.card-upd-pill');
        const timeRow = upd.querySelector('.card-upd-time');
        const intvRow = upd.querySelector('.card-upd-interval');
        const errorRow = upd.querySelector('.card-upd-error-msg');
        const ts = upd.getAttribute('data-updated') || '';
        const iv = upd.getAttribute('data-interval') || '';
        const isError = upd.getAttribute('data-error') === 'true';
        const errorMsg = upd.getAttribute('data-error-msg') || '';
        if (timeRow) timeRow.textContent = ts ? 'Last Updated: ' + ts : 'Last Updated: -';
        if (intvRow) intvRow.textContent = iv ? 'Interval: ' + iv : 'Interval: -';
        if (errorRow && isError && errorMsg) {
          errorRow.textContent = '⚠ ' + errorMsg;
        }
        if (pill && pop) {
          pill.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = pop.classList.contains('open');
            document.querySelectorAll('.card-upd-pop.open').forEach(other => {
              if (other !== pop) other.classList.remove('open');
            });
            pop.classList.toggle('open', !isOpen);
          });
        }
      }
      let dragEl = null;
      function bindCardDrag(card) {
        if (card.classList.contains('add-card')) return;
        card.addEventListener('dragstart', () => {
          dragEl = card;
          card.classList.add('dragging');
        });
        card.addEventListener('dragend', () => {
          dragEl = null;
          card.classList.remove('dragging');
          card.classList.remove('drag-over-top');
          card.classList.remove('drag-over-bottom');
        });
        card.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (!dragEl || dragEl === card) return;
          const rect = card.getBoundingClientRect();
          const offset = e.clientY - rect.top;
          const mid = rect.height / 2;
          card.classList.remove('drag-over-top', 'drag-over-bottom');
          if (offset < mid) card.classList.add('drag-over-top'); else card.classList.add('drag-over-bottom');
        });
        card.addEventListener('dragleave', () => {
          card.classList.remove('drag-over-top');
          card.classList.remove('drag-over-bottom');
        });
        card.addEventListener('drop', (e) => {
          e.preventDefault();
          const grid = document.getElementById('dashGrid');
          if (!dragEl || dragEl === card) {
            card.classList.remove('drag-over-top');
            card.classList.remove('drag-over-bottom');
            return;
          }
          const items = Array.from(grid.children);
          const from = items.indexOf(dragEl);
          const to = items.indexOf(card);
          if (from === -1 || to === -1) return;
          if (card.classList.contains('drag-over-bottom')) {
            grid.insertBefore(dragEl, card.nextSibling);
          } else {
            grid.insertBefore(dragEl, card);
          }
          card.classList.remove('drag-over-top');
          card.classList.remove('drag-over-bottom');
          charts.forEach(fn => fn());
        });
      }
      function initChartCard(card, canvas, series, color) {
        const dd = card.querySelector('.shape-dd');
        const btn = dd.querySelector('.shape-btn');
        const menu = dd.querySelector('.shape-menu');
        const ico = btn.querySelector('.shape-ico');
        btn.addEventListener('click', (e) => { e.preventDefault(); menu.classList.toggle('open'); });
        menu.querySelectorAll('.shape-item').forEach(item => {
          item.addEventListener('click', () => {
            const v = item.getAttribute('data-size');
            const cv = canvas;
            if (v === 'sq-s') { card.dataset.w = '1'; card.dataset.h = '1'; if (cv) cv.dataset.h = '160'; }
            if (v === 'sq-l') { card.dataset.w = '2'; card.dataset.h = '2'; if (cv) cv.dataset.h = '320'; }
            if (v === 'rect-h') { card.dataset.w = '2'; card.dataset.h = '1'; if (cv) cv.dataset.h = '160'; }
            if (v === 'rect-v') { card.dataset.w = '1'; card.dataset.h = '2'; if (cv) cv.dataset.h = '320'; }
            ico.setAttribute('data-cur', v);
            if (v === 'sq-s') ico.innerHTML = '<svg viewBox="0 0 16 16"><rect x="4" y="4" width="8" height="8" fill="#9ca3af"/></svg>';
            if (v === 'sq-l') ico.innerHTML = '<svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg>';
            if (v === 'rect-h') ico.innerHTML = '<svg viewBox="0 0 16 16"><rect x="2" y="4" width="12" height="8" fill="#9ca3af"/></svg>';
            if (v === 'rect-v') ico.innerHTML = '<svg viewBox="0 0 16 16"><rect x="4" y="2" width="8" height="12" fill="#9ca3af"/></svg>';
            menu.classList.remove('open');
            applyLayout();
            charts.forEach(fn => fn());
          });
        });
        document.addEventListener('click', (e) => { if (!dd.contains(e.target)) menu.classList.remove('open'); });
        bindCardDrag(card);
        charts.push(() => drawLineChart(canvas, series, color));
        charts.forEach(fn => fn());
      }
      function addChartCard(title) {
        const grid = document.getElementById('dashGrid');
        const card = document.createElement('div');
        card.className = 'chart-card';
        card.dataset.w = '1';
        card.dataset.h = '1';
        card.draggable = true;
        const id = 'chart-' + Date.now();
        card.id = id;
        card.innerHTML = '<div class="card-hd"><div class="card-title"></div><div class="card-ops"><div class="card-upd" data-updated="" data-interval="1w"><button class="card-upd-pill" type="button"><span class="card-upd-label">Last</span><span class="card-upd-value"></span></button><div class="card-upd-pop"><div class="card-upd-row card-upd-time"></div><div class="card-upd-row card-upd-interval"></div></div></div><div class="shape-dd"><button class="shape-btn" aria-label="Widget size"><span class="shape-ico" data-cur="sq-s"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg></span></button><div class="shape-menu"><button class="shape-item" data-size="sq-s"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="4" y="4" width="8" height="8" fill="#9ca3af"/></svg></span><span>1×1</span></button><button class="shape-item" data-size="sq-l"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" fill="#9ca3af"/></svg></span><span>2×2</span></button><button class="shape-item" data-size="rect-h"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="2" y="4" width="12" height="8" fill="#9ca3af"/></svg></span><span>2×1</span></button><button class="shape-item" data-size="rect-v"><span class="shape-ico"><svg viewBox="0 0 16 16"><rect x="4" y="2" width="8" height="12" fill="#9ca3af"/></svg></span><span>1×2</span></button></div></div></div></div><div class="chart-container"></div>';
        grid.appendChild(card);
        const titleEl = card.querySelector('.card-title');
        if (titleEl) titleEl.textContent = title || 'New Chart';
        const container = card.querySelector('.chart-container');
        const canvas = document.createElement('canvas');
        canvas.className = 'chart-canvas';
        container.appendChild(canvas);
        const series = genSeries();
        const idx = document.querySelectorAll('#dashGrid .chart-card').length;
        const color = idx % 3 === 0 ? '#0ea5e9' : idx % 3 === 1 ? '#7c3aed' : '#f59e0b';
        card.setAttribute('data-color', color);
        const upd = card.querySelector('.card-upd');
        let detailTs = '';
        let displayTs = '';
        if (upd) {
          const now = new Date();
          const mm = String(now.getMonth() + 1).padStart(2, '0');
          const dd = String(now.getDate()).padStart(2, '0');
          const hh = String(now.getHours()).padStart(2, '0');
          const mi = String(now.getMinutes()).padStart(2, '0');
          displayTs = mm.replace(/^0/, '') + '/' + dd.replace(/^0/, '') + ' ' + hh + ':' + mi;
          detailTs = now.getFullYear() + '-' + mm + '-' + dd + ' ' + hh + ':' + mi;
          upd.setAttribute('data-updated', detailTs);
          upd.setAttribute('data-interval', '1w');
          const valEl = upd.querySelector('.card-upd-value');
          if (valEl) valEl.textContent = displayTs;
        }
        const detailTitleEl = card.querySelector('.card-title');
        const detailTitle = detailTitleEl ? detailTitleEl.textContent.trim() : title || 'New Chart';
        chartDetails.set(id, {
          id,
          title: detailTitle,
          author: '@Sheer',
          created: detailTs || '',
          updated: detailTs || '',
          interval: '1w',
          series,
          color,
          version: 'V1'
        });
        initChartCard(card, canvas, series, color);
        initCardUpdate(card);
        applyLayout();
        return { id, color };
      }
      function parseChartCommand(input) {
        const t = (input || '').trim();
        let m = t.match(/^(?:add|create)\s+chart\s*:?(.+)$/i);
        if (!m) m = t.match(/新增图表[:：]?\s*(.+)$/);
        if (!m) m = t.match(/^(?:add|新增)(?:\s+(.+))?$/i);
        if (!m) return null;
        const title = (m[1] || '').trim();
        return { title: title || 'New Chart' };
      }
      function parseStrategyCommand(input) {
        const t = (input || '').trim();
        let m = t.match(/^(?:add|create)\s+strategy\s*:?(.+)$/i);
        if (!m) m = t.match(/新增策略[:：]?\s*(.+)$/);
        if (!m) return null;
        const title = (m[1] || '').trim();
        return { title: title || 'New Strategy' };
      }
      function getChartsList() {
        return Array.from(document.querySelectorAll('#dashGrid .chart-card')).map(card => {
          const title = (card.querySelector('.card-title')?.textContent || 'Chart').trim();
          return { id: card.id || '', title };
        });
      }
      function buildMentionMenu() {
        const menu = document.getElementById('mentionMenu');
        const listEl = menu.querySelector('.mention-list');
        const data = getChartsList();
        listEl.innerHTML = data.map(d => `<button class="mention-item" data-id="${d.id}" data-title="${d.title}"># ${d.title}</button>`).join('');
        menu.style.display = 'block';
        const compose = document.querySelector('.chat-compose');
        const inputRect = cfgChatInput.getBoundingClientRect();
        const composeRect = compose.getBoundingClientRect();
        const menuRect = menu.getBoundingClientRect();
        const left = inputRect.left - composeRect.left + 8;
        const top = inputRect.top - composeRect.top - menuRect.height - 8;
        menu.style.left = left + 'px';
        menu.style.top = Math.max(0, top) + 'px';
        menu.classList.add('open');
        listEl.querySelectorAll('.mention-item').forEach(btn => {
          btn.addEventListener('click', () => {
            const title = btn.getAttribute('data-title');
            addMention(title);
            menu.classList.remove('open');
            menu.style.display = 'none';
          });
        });
      }
      function insertAtCursor(el, text) {
        const start = el.selectionStart || 0;
        const end = el.selectionEnd || 0;
        const val = el.value || '';
        el.value = val.slice(0, start) + text + val.slice(end);
        el.selectionStart = el.selectionEnd = start + text.length;
        el.focus();
        // Trigger input event to update mention chips (this will call renderMentionChips)
        el.dispatchEvent(new Event('input', { bubbles: true }));
        // Also call directly to ensure it runs
        setTimeout(() => renderMentionChips(), 0);
      }
      function escapeHtml(text) {
        return (text || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }
      function renderInlineMarkdown(text) {
        if (!text) return '';
        // First escape HTML to prevent XSS
        const esc = escapeHtml(text);
        // Then convert markdown code blocks (backticks) to HTML code tags with table icon
        // Match backticks that are not already escaped
        const tableIcon = '<svg style="display: inline-block; width: 11px; height: 11px; vertical-align: middle; margin-right: 5px; opacity: 0.75; flex-shrink: 0;" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="12" height="12" stroke="currentColor" stroke-width="1" fill="none"/><line x1="2" y1="6" x2="14" y2="6" stroke="currentColor" stroke-width="1"/><line x1="2" y1="10" x2="14" y2="10" stroke="currentColor" stroke-width="1"/><line x1="6" y1="2" x2="6" y2="14" stroke="currentColor" stroke-width="1"/><line x1="10" y1="2" x2="10" y2="14" stroke="currentColor" stroke-width="1"/></svg>';
        return esc.replace(/`([^`]+)`/g, '<code style="white-space: nowrap;"><span style="display: inline-flex; align-items: center;">' + tableIcon + '<span>$1</span></span></code>');
      }
      const dashboardView = document.getElementById('dashboardView');
      const detailOverlay = document.getElementById('chartDetailOverlay');
      const detailClose = document.getElementById('detailClose');
      const detailTitle = document.getElementById('detailTitle');
      const detailSubtitle = document.getElementById('detailSubtitle');
      const detailAuthor = document.getElementById('detailAuthor');
      const detailCreated = document.getElementById('detailCreated');
      const detailUpdated = document.getElementById('detailUpdated');
      const detailInterval = document.getElementById('detailInterval');
      const detailLogicText = document.getElementById('detailLogicText');
      const detailChartCanvas = document.getElementById('detailChartCanvas');
      const detailTableBody = document.getElementById('detailTableBody');
      const detailDownload = document.getElementById('detailDownload');
      function buildDetailDesc(meta) {
        const t = (meta.title || '').toLowerCase();
        let baseText = '';
        let dataStream = 'BTC 价格';
        if (t.includes('sol') && t.includes('rsi')) {
          baseText = 'This chart displays the Relative Strength Index (RSI) for SOL, a momentum oscillator that measures the speed and magnitude of price changes. RSI values range from 0 to 100, with readings above 70 typically indicating overbought conditions and below 30 indicating oversold conditions.';
          dataStream = 'SOL RSI';
        } else if (t.includes('eth') && t.includes('funding')) {
          baseText = 'This chart tracks the ETH perpetual futures funding rate across major exchanges. Funding rates indicate market sentiment: positive rates suggest longs pay shorts (bullish bias), negative rates suggest shorts pay longs (bearish bias). Extreme values often precede mean-reversion moves.';
          dataStream = 'ETH Funding Rate';
        } else if (t.includes('btc') && t.includes('ma25') && (t.includes(' w') || t.endsWith('w'))) {
          baseText = 'This chart shows the 25‑period moving average of BTC on the weekly timeframe. Each point is the arithmetic mean of the latest 25 weekly closes, smoothing out short‑term noise and highlighting medium‑term trend shifts and key support/resistance areas.';
        } else if (t.includes('btc') && t.includes('ma25')) {
          baseText = 'This chart shows a 25‑period moving average of BTC on the selected timeframe. It averages the last 25 candle closes to filter out minor fluctuations and focus on the mid‑term structure of price action.';
        } else {
          baseText = 'This chart is built from a time‑series dataset where each point represents the value observed at a fixed interval. It is useful for reading trend direction, rhythm of swings and local extremes, which together help evaluate market regime and strategy performance.';
          dataStream = 'data stream';
        }
        return baseText + ' Referenced from the `' + dataStream + '` data stream.';
      }
      function buildSubtitle(meta) {
        const bookIcon = '<svg class="detail-subtitle-book-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 2h10v12H3V2zm1 1v10h8V3H4z" stroke="currentColor" stroke-width="1" fill="none"/><path d="M5 3h6M5 5h6M5 7h4" stroke="currentColor" stroke-width="0.8" fill="none"/></svg>';
        const title = meta.title || 'Chart';
        let description = title;
        const t = title.toLowerCase();
        if (t.includes('btc') && t.includes('ma')) {
          if (t.includes('weekly') || t.includes(' w') || t.endsWith('w')) {
            description = 'BTC Weekly MA7–MA25 Crossover Allocator';
          } else {
            description = 'BTC MA7–MA25 Crossover Allocator';
          }
        } else if (t.includes('eth') && t.includes('funding')) {
          description = 'ETH Perpetual Funding Rate Monitor';
        } else if (t.includes('sol') && t.includes('rsi')) {
          description = 'SOL RSI Indicator';
        }
        
        const version = meta.version || 'V1';
        const versionBadge = '<span class="detail-version-badge">' + version + '</span>';
        
        // Check if this chart has error state
        if (meta.isError) {
          const errorDot = '<span class="detail-status-dot detail-status-dot-error" title="Error" aria-label="Error"></span>';
          return 'Created by @Sheer · ' + bookIcon + ' ' + description + ' ' + versionBadge + ' ' + errorDot;
        }
        
        const runningDot = '<span class="detail-status-dot" title="Running" aria-label="Running"></span>';
        return 'Created by @Sheer · ' + bookIcon + ' ' + description + ' ' + versionBadge + ' ' + runningDot;
      }
      function buildCodeContent(meta) {
        const t = (meta.title || '').toLowerCase();
        if (t.includes('sol') && t.includes('rsi')) {
          return `// SOL Relative Strength Index (RSI)
const symbol = 'SOLUSDT';
const period = 14;

// Fetch historical price data
const candles = await fetchOHLC({
  symbol: symbol,
  timeframe: '1h',
  limit: 100
});

// Calculate RSI
const closes = candles.map(c => c.close);
const rsi = calculateRSI(closes, period);

// Return the latest RSI value
return rsi[rsi.length - 1];`;
        }
        if (t.includes('eth') && t.includes('funding')) {
          return `// ETH Perpetual Funding Rate
const symbol = 'ETHUSDT';
const exchanges = ['binance', 'okx', 'bybit'];

// Fetch funding rates from multiple exchanges
const fundingRates = await Promise.all(
  exchanges.map(ex => fetchFundingRate({
    exchange: ex,
    symbol: symbol
  }))
);

// Calculate average funding rate
const avgRate = fundingRates.reduce((sum, r) => sum + r.rate, 0) / fundingRates.length;

// Return funding rate data
return {
  rate: avgRate,
  timestamp: Date.now(),
  exchanges: fundingRates
};`;
        }
        if (t.includes('btc') && t.includes('ma25')) {
          return `// BTC 25-period Moving Average
const symbol = 'BTCUSDT';
const period = 25;
const timeframe = '1w';

// Fetch historical data
const candles = await fetchOHLC({
  symbol: symbol,
  timeframe: timeframe,
  limit: 100
});

// Calculate moving average
const closes = candles.map(c => c.close);
const ma25 = calculateMA(closes, period);

// Return the latest MA value
return ma25[ma25.length - 1];`;
        }
        return `// Generic Moving Average Calculation
const period = 25;
const data = await fetchDataStream('data_stream');

// Calculate moving average
const ma = calculateMovingAverage(data, period);

// Return result
return ma;`;
      }
      function showDashboardView() {
        if (dashboardView) dashboardView.style.display = '';
        if (detailOverlay) detailOverlay.classList.remove('open');
      }
      function openChartDetail(cardId) {
        const meta = chartDetails.get(cardId);
        if (!meta || !detailOverlay) return;
        detailTitle.textContent = meta.title || 'Chart';
        if (detailSubtitle) {
          detailSubtitle.innerHTML = buildSubtitle(meta);
        }
        
        // Handle error banner
        const existingBanner = document.getElementById('detailErrorBanner');
        if (existingBanner) existingBanner.remove();
        
        if (meta.isError && meta.errorMsg) {
          const banner = document.createElement('div');
          banner.id = 'detailErrorBanner';
          banner.className = 'detail-error-banner';
          const isBreakingChange = meta.errorType === 'breaking-change';
          const isArchived = meta.errorType === 'archived';
          let bannerContent = '<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 1L15 14H1L8 1Z" stroke="currentColor" stroke-width="1.5" fill="none"/><path d="M8 6v4M8 11.5v.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg><span>' + meta.errorMsg + '</span>';
          if (isBreakingChange) {
            bannerContent += '<button id="detailUpgradeBtn" class="detail-upgrade-btn">Upgrade</button>';
          } else if (isArchived) {
            bannerContent += '<button id="detailDeleteBtn" class="detail-delete-btn">Delete</button>';
          }
          banner.innerHTML = bannerContent;
          const headerLeft = document.querySelector('.detail-header-left');
          if (headerLeft) {
            headerLeft.appendChild(banner);
          }
          
          // Handle upgrade button
          if (isBreakingChange) {
            const upgradeBtn = document.getElementById('detailUpgradeBtn');
            if (upgradeBtn) {
              upgradeBtn.addEventListener('click', () => {
                // Get current widget ID
                const currentWidgetId = detailOverlay.dataset.currentId;
                if (!currentWidgetId) return;
                
                // Show button loading
                upgradeBtn.disabled = true;
                upgradeBtn.classList.add('loading');
                
                // Simulate upgrade process
                setTimeout(() => {
                  // Update banner to success state
                  banner.classList.remove('detail-error-banner');
                  banner.classList.add('detail-error-banner', 'success');
                  
                  // Update banner content
                  const successIcon = '<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" fill="none"/><path d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                  const successMsg = 'Upgraded to latest version. Data stream updates resumed.';
                  banner.innerHTML = successIcon + '<span>' + successMsg + '</span>';
                  
                  // Remove upgrade button
                  upgradeBtn.remove();
                  
                  // Update card state in dashboard
                  const card = document.getElementById(currentWidgetId);
                  if (card) {
                    // Remove error classes
                    card.classList.remove('card-error');
                    const cardUpd = card.querySelector('.card-upd');
                    if (cardUpd) {
                      cardUpd.removeAttribute('data-error');
                      cardUpd.removeAttribute('data-error-type');
                      cardUpd.classList.remove('card-upd-error');
                      
                      // Update card update pill
                      const pill = cardUpd.querySelector('.card-upd-pill');
                      if (pill) {
                        pill.classList.remove('card-upd-pill-error');
                        const errorIcon = pill.querySelector('.card-error-icon');
                        if (errorIcon) errorIcon.remove();
                        const label = pill.querySelector('.card-upd-label');
                        if (label) label.textContent = 'Last';
                        const value = pill.querySelector('.card-upd-value');
                        if (value) {
                          const now = new Date();
                          const mm = String(now.getMonth() + 1).padStart(2, '0');
                          const dd = String(now.getDate()).padStart(2, '0');
                          const hh = String(now.getHours()).padStart(2, '0');
                          const mi = String(now.getMinutes()).padStart(2, '0');
                          value.textContent = mm.replace(/^0/, '') + '/' + dd.replace(/^0/, '') + ' ' + hh + ':' + mi;
                        }
                      }
                      
                      // Update card update time
                      const now = new Date();
                      const mm = String(now.getMonth() + 1).padStart(2, '0');
                      const dd = String(now.getDate()).padStart(2, '0');
                      const hh = String(now.getHours()).padStart(2, '0');
                      const mi = String(now.getMinutes()).padStart(2, '0');
                      const updated = now.getFullYear() + '-' + mm + '-' + dd + ' ' + hh + ':' + mi;
                      cardUpd.setAttribute('data-updated', updated);
                    }
                  }
                  
                  // Update chartDetails meta
                  const meta = chartDetails.get(currentWidgetId);
                  if (meta) {
                    meta.isError = false;
                    meta.errorMsg = '';
                    meta.errorType = '';
                    meta.updated = new Date().toISOString().slice(0, 16).replace('T', ' ');
                    meta.version = 'V2';
                    
                    // Update subtitle with new version
                    if (detailSubtitle) {
                      detailSubtitle.innerHTML = buildSubtitle(meta);
                    }
                  }
                  
                  // Auto-hide success banner after 5 seconds
                  setTimeout(() => {
                    banner.style.opacity = '0';
                    setTimeout(() => {
                      banner.remove();
                    }, 300);
                  }, 5000);
                }, 1500);
              });
            }
          }
          
          // Handle delete button for archived widgets
          if (isArchived) {
            const deleteBtn = document.getElementById('detailDeleteBtn');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', () => {
                // Get current widget ID
                const currentWidgetId = detailOverlay.dataset.currentId;
                if (!currentWidgetId) return;
                
                // Confirm deletion
                if (confirm('Are you sure you want to delete this archived widget? This action cannot be undone.')) {
                  // Remove card from dashboard
                  const card = document.getElementById(currentWidgetId);
                  if (card) {
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                      card.remove();
                      // Remove from chartDetails
                      chartDetails.delete(currentWidgetId);
                      // Close detail overlay
                      showDashboardView();
                      // Reapply layout
                      applyLayout();
                    }, 300);
                  } else {
                    // If card not found, just close detail overlay
                    showDashboardView();
                  }
                }
              });
            }
          }
        }
        
        detailCreated.textContent = meta.created || '-';
        detailUpdated.textContent = meta.updated || '-';
        detailInterval.textContent = meta.interval || '-';
        const detailLogicTextEl = document.getElementById('detailLogicText');
        const detailCodeTextEl = document.getElementById('detailCodeText');
        const detailCodeContentEl = document.getElementById('detailCodeContent');
        if (detailLogicTextEl) {
          const desc = buildDetailDesc(meta);
          detailLogicTextEl.innerHTML = renderInlineMarkdown(desc);
          detailLogicTextEl.style.display = 'block';
        }
        if (detailCodeTextEl && detailCodeContentEl) {
          detailCodeContentEl.textContent = buildCodeContent(meta);
          detailCodeTextEl.style.display = 'none';
        }
        detailTableBody.innerHTML = '';
        const arr = meta.series || [];
        arr.forEach((v, i) => {
          const tr = document.createElement('tr');
          const idxTd = document.createElement('td');
          idxTd.textContent = String(i + 1);
          const valTd = document.createElement('td');
          valTd.textContent = typeof v === 'number' && v.toFixed ? v.toFixed(4) : String(v);
          tr.appendChild(idxTd);
          tr.appendChild(valTd);
          detailTableBody.appendChild(tr);
        });
        if (detailChartCanvas && meta.series) {
          drawLineChart(detailChartCanvas, meta.series, meta.color || '#0ea5e9');
        }
        if (dashboardView) dashboardView.style.display = 'none';
        detailOverlay.classList.add('open');
        detailOverlay.dataset.currentId = cardId;
        const toggleBtns = document.querySelectorAll('.detail-view-toggle-btn');
        toggleBtns.forEach(b => {
          if (b.getAttribute('data-view') === 'idea') {
            b.classList.add('active');
          } else {
            b.classList.remove('active');
          }
        });
      }
      if (detailDownload && detailOverlay) {
        detailDownload.addEventListener('click', () => {
          const id = detailOverlay.dataset.currentId;
          const meta = chartDetails.get(id);
          if (!meta || !meta.series) return;
          let csv = 'index,value\n';
          meta.series.forEach((v, i) => {
            csv += (i + 1) + ',' + v + '\n';
          });
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = (meta.title || 'chart') + '.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }
      const detailUseBtn = document.getElementById('detailUseBtn');
      const detailRemixBtn = document.getElementById('detailRemixBtn');
      if (detailUseBtn && detailOverlay) {
        detailUseBtn.addEventListener('click', () => {
          const id = detailOverlay.dataset.currentId;
          const meta = chartDetails.get(id);
          if (!meta || !meta.title) return;
          if (window.addMention) {
            window.addMention(meta.title);
          }
          const cfgChatInput = document.getElementById('cfgChatInput');
          if (cfgChatInput) {
            cfgChatInput.value = 'Add this Data Stream to the current Playbook';
          }
        });
      }
      if (detailRemixBtn && detailOverlay) {
        detailRemixBtn.addEventListener('click', () => {
          const id = detailOverlay.dataset.currentId;
          const meta = chartDetails.get(id);
          if (!meta || !meta.title) return;
          if (window.addMention) {
            window.addMention(meta.title);
          }
          const cfgChatInput = document.getElementById('cfgChatInput');
          if (cfgChatInput) {
            cfgChatInput.value = 'How to modify based on this Data Stream';
          }
        });
      }
      document.addEventListener('click', (e) => {
        const toggleBtn = e.target.closest('.detail-view-toggle-btn');
        if (!toggleBtn) return;
        const view = toggleBtn.getAttribute('data-view');
        const allBtns = document.querySelectorAll('.detail-view-toggle-btn');
        allBtns.forEach(b => b.classList.remove('active'));
        toggleBtn.classList.add('active');
        const id = detailOverlay.dataset.currentId;
        const meta = chartDetails.get(id);
        const detailLogicText = document.getElementById('detailLogicText');
        const detailCodeText = document.getElementById('detailCodeText');
        const detailCodeContent = document.getElementById('detailCodeContent');
        if (view === 'code') {
          if (detailLogicText) detailLogicText.style.display = 'none';
          if (detailCodeText && detailCodeContent && meta) {
            detailCodeContent.textContent = buildCodeContent(meta);
            detailCodeText.style.display = 'block';
          }
        } else {
          if (detailLogicText) detailLogicText.style.display = 'block';
          if (detailCodeText) detailCodeText.style.display = 'none';
        }
      });
      const detailReferences = document.getElementById('detailReferences');
      const referencesPopover = document.getElementById('referencesPopover');
      const referencesList = document.getElementById('referencesList');
      const detailRemixs = document.getElementById('detailRemixs');
      const remixsPopover = document.getElementById('remixsPopover');
      const remixsList = document.getElementById('remixsList');
      const mockReferences = [
        'Dashboard-Playbook A',
        'Strategy-Playbook B',
        'Research-Playbook C',
        'Portfolio Lens',
        'Smart Screener',
        'Risk Monitors',
        'Macro Pulse',
        'Quant Signals',
        'Crypto Intel',
        'Asset Tracker',
        'Social Insight',
        'US Crypto DAT Monitor',
        'US Crypto ETF Monitor',
        'Factor Tilt Analysis',
        'Tail Risk Indicators',
        'AI Revenue Exposure',
        'Momentum Screener'
      ];
      const mockRemixs = [
        { user: '@alice', time: '2025-12-05 14:30', title: 'Btc Ma25 Prev (Custom)' },
        { user: '@bob', time: '2025-12-04 09:15', title: 'BTC MA25 Weekly' },
        { user: '@charlie', time: '2025-12-03 16:45', title: 'Btc Ma25 Extended' },
        { user: '@diana', time: '2025-12-02 11:20', title: 'BTC Moving Average 25' },
        { user: '@eve', time: '2025-12-01 13:10', title: 'Btc Ma25 Prev v2' }
      ];
      function buildReferencesList() {
        if (!referencesList) return;
        referencesList.innerHTML = mockReferences.map(ref => 
          `<div class="detail-meta-popover-item">${ref}</div>`
        ).join('');
      }
      function buildRemixsList() {
        if (!remixsList) return;
        remixsList.innerHTML = mockRemixs.map(remix => 
          `<div class="detail-meta-popover-item">
            <div style="font-weight: 600; margin-bottom: 2px;">${remix.title}</div>
            <div style="font-size: 11px; color: var(--muted);">${remix.user} · ${remix.time}</div>
          </div>`
        ).join('');
      }
      if (detailReferences && referencesPopover) {
        detailReferences.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = referencesPopover.classList.contains('open');
          document.querySelectorAll('.detail-meta-popover.open').forEach(pop => {
            if (pop !== referencesPopover) pop.classList.remove('open');
          });
          referencesPopover.classList.toggle('open', !isOpen);
          if (!isOpen) buildReferencesList();
        });
      }
      if (detailRemixs && remixsPopover) {
        detailRemixs.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = remixsPopover.classList.contains('open');
          document.querySelectorAll('.detail-meta-popover.open').forEach(pop => {
            if (pop !== remixsPopover) pop.classList.remove('open');
          });
          remixsPopover.classList.toggle('open', !isOpen);
          if (!isOpen) buildRemixsList();
        });
      }
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.detail-meta-clickable')) {
          document.querySelectorAll('.detail-meta-popover.open').forEach(pop => {
            pop.classList.remove('open');
          });
        }
      });
      window.addEventListener('resize', () => { charts.forEach(fn => fn()); });
      applyLayout();
      setupCharts();
      
      // Handle URL parameter to open chart detail from other pages
      const urlParams = new URLSearchParams(window.location.search);
      const openChartTitle = urlParams.get('openChart');
      if (openChartTitle) {
        // Find chart by title and open its detail
        setTimeout(() => {
          for (const [cardId, meta] of chartDetails.entries()) {
            if (meta.title && meta.title.toLowerCase().includes(openChartTitle.toLowerCase())) {
              openChartDetail(cardId);
              break;
            }
          }
        }, 100);
      }
      document.querySelectorAll('#dashGrid .shape-dd').forEach(dd => {
        const btn = dd.querySelector('.shape-btn');
        const menu = dd.querySelector('.shape-menu');
        const ico = btn.querySelector('.shape-ico');
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          menu.classList.toggle('open');
        });
        menu.querySelectorAll('.shape-item').forEach(item => {
          item.addEventListener('click', () => {
            const v = item.getAttribute('data-size');
            const card = dd.closest('.chart-card');
            const canvas = card.querySelector('canvas.chart-canvas');
            if (v === 'sq-s') { card.dataset.w = '1'; card.dataset.h = '1'; if (canvas) canvas.dataset.h = '160'; }
            if (v === 'sq-l') { card.dataset.w = '2'; card.dataset.h = '2'; if (canvas) canvas.dataset.h = '320'; }
            if (v === 'rect-h') { card.dataset.w = '2'; card.dataset.h = '1'; if (canvas) canvas.dataset.h = '160'; }
            if (v === 'rect-v') { card.dataset.w = '1'; card.dataset.h = '2'; if (canvas) canvas.dataset.h = '320'; }
            ico.setAttribute('data-cur', v);
            // update icon graphic
            if (v === 'sq-s') ico.innerHTML = '<svg viewBox=\"0 0 16 16\"><rect x=\"4\" y=\"4\" width=\"8\" height=\"8\" fill=\"#9ca3af\"/></svg>';
            if (v === 'sq-l') ico.innerHTML = '<svg viewBox=\"0 0 16 16\"><rect x=\"2\" y=\"2\" width=\"12\" height=\"12\" fill=\"#9ca3af\"/></svg>';
            if (v === 'rect-h') ico.innerHTML = '<svg viewBox=\"0 0 16 16\"><rect x=\"2\" y=\"4\" width=\"12\" height=\"8\" fill=\"#9ca3af\"/></svg>';
            if (v === 'rect-v') ico.innerHTML = '<svg viewBox=\"0 0 16 16\"><rect x=\"4\" y=\"2\" width=\"8\" height=\"12\" fill=\"#9ca3af\"/></svg>';
            menu.classList.remove('open');
            applyLayout();
            charts.forEach(fn => fn());
          });
        });
        document.addEventListener('click', (e) => {
          if (!dd.contains(e.target)) menu.classList.remove('open');
        });
      });
      document.querySelectorAll('#dashGrid .chart-card').forEach(card => {
        bindCardDrag(card);
      });
      document.querySelectorAll('#dashGrid .chart-card').forEach(card => {
        initCardUpdate(card);
      });
      document.addEventListener('click', (e) => {
        const titleEl = e.target.closest('.card-title');
        if (!titleEl) return;
        const card = titleEl.closest('.chart-card');
        if (!card) return;
        if (!card.id) card.id = 'chart-' + Date.now();
        openChartDetail(card.id);
      });
      // Chat Panel - using shared component
      const contextData = {
        playbooks: [
          { label: 'Attribution Analysis Strategy for Price Trends', badge: 'Current', icon: 'chart' },
          { label: 'NVDA Price Fetcher', icon: 'chart' },
          { label: 'BTC Dip Mean-Reversion RSI Bollinger v2', icon: 'refresh' }
        ],
        threads: [
          { label: 'TSLA Financial Trends and Charts Analysis', icon: 'list' },
          { label: 'US Treasury Yield and Bitcoin Correlation Analysis', icon: 'list' }
        ],
        widgets: [
          { label: 'chart_nvda_revenue_qoq_yoy', icon: 'widget' },
          { label: 'chart_nvda_core_segments_trend', icon: 'widget' },
          { label: 'nvda_quarterly_revenue_change_chart', icon: 'widget' },
          { label: 'nvda_price_volatility_chart', icon: 'widget' }
        ],
        dataStream: [
          { label: 'chart_nvda_revenue_qoq_yoy', icon: 'widget' },
          { label: 'chart_nvda_core_segments_trend', icon: 'widget' }
        ],
        universe: [
          { label: 'chart_nvda_revenue_qoq_yoy', icon: 'widget' },
          { label: 'chart_nvda_core_segments_trend', icon: 'widget' }
        ]
      };

      function runChatFlow(text, chatPanel) {
        const cfgChatList = chatPanel.elements.cfgChatList;
        const you = document.createElement('div');
        you.className = 'chat-msg msg-you';
        you.innerHTML = '<div class="chat-role">You</div><div>' + renderInlineMarkdown(text) + '</div>';
        cfgChatList.appendChild(you);
        setTimeout(() => {
          const ai = document.createElement('div');
          ai.className = 'chat-msg msg-ai';
          const chatModeBtn = document.getElementById('chatModeBtn');
          const mode = chatModeBtn ? chatModeBtn.getAttribute('data-mode') : 'charts';
          const cmd = mode === 'strategy' ? parseStrategyCommand(text) : parseChartCommand(text);
          if (cmd && mode === 'charts') {
            ai.innerHTML = '<div class="chat-role">AI</div><div><span class="spin"></span>Thinking…</div>';
            cfgChatList.appendChild(ai);
            cfgChatList.scrollTop = cfgChatList.scrollHeight;
            setTimeout(() => { ai.innerHTML = '<div class="chat-role">AI</div><div><span class="spin"></span>Analyzing instruction…</div>'; cfgChatList.scrollTop = cfgChatList.scrollHeight; }, 600);
            setTimeout(() => { ai.innerHTML = '<div class="chat-role">AI</div><div><span class="spin"></span>Generating data series…</div>'; cfgChatList.scrollTop = cfgChatList.scrollHeight; }, 1200);
            let createdMeta = null;
            setTimeout(() => { createdMeta = addChartCard(cmd.title); ai.innerHTML = '<div class="chat-role">AI</div><div><span class="spin"></span>Rendering chart…</div>'; cfgChatList.scrollTop = cfgChatList.scrollHeight; }, 1800);
            setTimeout(() => {
              const target = (createdMeta && createdMeta.id) || '';
              ai.innerHTML = '<div class="chat-role">AI</div><div class="chat-result-card"><div class="res-title">' + cmd.title + '</div><div class="res-meta">已创建图表并加入 Dashboard</div><div class="res-thumb"><canvas class="res-thumb-canvas" data-h="42"></canvas></div><div class="res-actions"><button class="btn-view" data-target="' + target + '">View Detail</button></div></div>';
              const thumb = ai.querySelector('.res-thumb-canvas');
              if (thumb) {
                thumb.dataset.h = '42';
                const seriesMini = genSeries();
                const colMini = (createdMeta && createdMeta.color) || '#22c55e';
                drawLineChart(thumb, seriesMini, colMini);
              }
              const btn = ai.querySelector('.btn-view');
              if (btn) {
                btn.addEventListener('click', () => {
                  const el = document.getElementById(btn.getAttribute('data-target'));
                  if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('drag-over');
                    setTimeout(() => el.classList.remove('drag-over'), 800);
                  }
                });
              }
              cfgChatList.scrollTop = cfgChatList.scrollHeight;
            }, 2400);
          } else if (cmd && mode === 'strategy') {
            ai.innerHTML = '<div class="chat-role">AI</div><div><span class="spin"></span>Thinking…</div>';
            cfgChatList.appendChild(ai);
            cfgChatList.scrollTop = cfgChatList.scrollHeight;
            setTimeout(() => { ai.innerHTML = '<div class="chat-role">AI</div><div><span class="spin"></span>Analyzing instruction…</div>'; cfgChatList.scrollTop = cfgChatList.scrollHeight; }, 600);
            setTimeout(() => { ai.innerHTML = '<div class="chat-role">AI</div><div><span class="spin"></span>Composing strategy rule set…</div>'; cfgChatList.scrollTop = cfgChatList.scrollHeight; }, 1200);
            setTimeout(() => {
              ai.innerHTML = '<div class="chat-role">AI</div><div class="chat-result-card"><div class="res-title">' + cmd.title + '</div><div class="res-meta">已创建策略（模拟）</div></div>';
              cfgChatList.scrollTop = cfgChatList.scrollHeight;
            }, 1800);
          } else {
            ai.innerHTML = '<div class="chat-role">AI</div><div>Noted. This box is for chatting about the current playbook.</div>';
            cfgChatList.appendChild(ai);
            cfgChatList.scrollTop = cfgChatList.scrollHeight;
          }
        }, 500);
      }

      const chatPanel = new ChatPanel('configPanel', {
        contextData: contextData,
        onSend: (text, panel) => {
          runChatFlow(text, panel);
        }
      });

      // Expose addMention for use by detail page buttons
      window.addMention = (label) => {
        if (chatPanel) {
          chatPanel.addMentionFromExternal(label);
        }
      };
      const miniChatBtn = document.getElementById('miniChatBtn');
      const miniChat = document.getElementById('miniChat');
      const miniChatClose = document.getElementById('miniChatClose');
      const miniChatInput = document.getElementById('miniChatInput');
      const miniChatSend = document.getElementById('miniChatSend');
      function openMiniChat() {
        if (!miniChat) return;
        miniChat.classList.add('open');
        miniChat.style.right = 'auto';
        miniChat.style.bottom = 'auto';
        const panel = document.getElementById('dashPanel');
        if (panel && miniChatBtn) {
          const btnRect = miniChatBtn.getBoundingClientRect();
          const panelRect = panel.getBoundingClientRect();
          let top = btnRect.bottom - panelRect.top + 8;
          let left = btnRect.left - panelRect.left;
          const maxLeft = panelRect.width - miniChat.offsetWidth - 16;
          if (!Number.isFinite(maxLeft)) {
            miniChat.style.left = left + 'px';
            miniChat.style.top = top + 'px';
          } else {
            if (left > maxLeft) left = Math.max(0, maxLeft);
            miniChat.style.left = left + 'px';
            miniChat.style.top = top + 'px';
          }
        }
        if (miniChatInput) {
          miniChatInput.focus();
          miniChatInput.select();
        }
      }
      function closeMiniChat() {
        if (!miniChat) return;
        miniChat.classList.remove('open');
      }
      function handleMiniChatSend() {
        if (!miniChatInput) return;
        const text = miniChatInput.value.trim();
        if (!text) return;
        miniChatInput.value = '';
        closeMiniChat();
        runChatFlow(text);
      }
      if (miniChatBtn) {
        miniChatBtn.addEventListener('click', (e) => {
          e.preventDefault();
          openMiniChat();
        });
      }
      if (miniChatClose) {
        miniChatClose.addEventListener('click', (e) => {
          e.preventDefault();
          closeMiniChat();
        });
      }
      if (miniChatSend) {
        miniChatSend.addEventListener('click', (e) => {
          e.preventDefault();
          handleMiniChatSend();
        });
      }
      if (miniChatInput) {
        miniChatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
            e.preventDefault();
            handleMiniChatSend();
          }
        });
      }
      document.addEventListener('click', (e) => {
        if (!miniChat || !miniChat.classList.contains('open')) return;
        const target = e.target;
        if (miniChatBtn && miniChatBtn.contains(target)) return;
        if (!miniChat.contains(target)) {
          closeMiniChat();
        }
      });
    </script>
    <script>
      // Edit History Panel
      const editHistoryBtn = document.getElementById('editHistoryBtn');
      const editHistoryPanel = document.getElementById('editHistoryPanel');
      const editHistoryBody = document.getElementById('editHistoryBody');
      
      // Mock history data - grouped by version sections
      const editHistoryData = [
        {
          version: 'Unreleased Draft',
          items: [
            {
              id: 'unreleased-1',
              description: 'Monitoring list expanded to include Meta, AAPL, etc.',
              date: '11/12/2025 16:52',
              viewing: true
            }
          ]
        },
        {
          version: 'V2',
          date: '11/12/2025 16:52',
          items: [
            {
              id: 'v2-1',
              description: 'Changed schedule from every 30 minutes to every 20 minutes.',
              date: '11/12/2025 16:52'
            }
          ]
        },
        {
          version: 'V1',
          date: '11/12/2025 16:52',
          items: [
            {
              id: 'v1-1',
              description: 'Changed schedule from every 30 minutes to every 20 minutes.',
              date: '11/12/2025 16:52'
            },
            {
              id: 'v1-2',
              description: 'Changed schedule from every 30 minutes to every 20 minutes.',
              date: '11/12/2025 16:52'
            }
          ]
        },
        {
          version: 'V0',
          date: '11/12/2025 16:52',
          items: [
            {
              id: 'v0-1',
              description: 'Changed schedule from every 30 minutes to every 20 minutes.',
              date: '11/12/2025 16:52'
            },
            {
              id: 'v0-2',
              description: 'Changed schedule from every 30 minutes to every 20 minutes.',
              date: '11/12/2025 16:52'
            }
          ]
        }
      ];
      
      function renderHistoryItem(item) {
        return `
          <div class="edit-history-item${item.viewing ? ' viewing' : ''}" data-id="${item.id}">
            <div class="edit-history-item-header">
              ${item.viewing ? `
                <div class="edit-history-check">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </div>
              ` : ''}
            </div>
            <div class="edit-history-description">${item.description}</div>
            <div class="edit-history-timestamp">
              ${item.date}
              ${item.viewing ? ' | <svg style="display: inline; width: 12px; height: 12px; vertical-align: middle; margin: 0 2px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/></svg> You are viewing' : ''}
            </div>
          </div>
        `;
      }
      
      function renderEditHistory() {
        if (!editHistoryBody) return;
        let html = '';
        
        editHistoryData.forEach((section, index) => {
          const headerText = section.date ? `${section.version} • ${section.date}` : section.version;
          const isUnreleased = section.version === 'Unreleased' || section.version === 'Unreleased Draft';
          html += `<div class="edit-history-section" data-section-index="${index}">
            <div class="edit-history-section-header">
              <span>${headerText}</span>
              ${isUnreleased ? `<button class="edit-history-discard-btn" title="Discard changes" onclick="discardUnreleased(event)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 14L4 9l5-5"></path>
                  <path d="M20 20v-7a4 4 0 0 0-4-4H4"></path>
                </svg>
              </button>` : ''}
            </div>
            ${section.items.map(item => renderHistoryItem(item)).join('')}
          </div>`;
        });
        
        editHistoryBody.innerHTML = html;
      }
      
      function discardUnreleased(event) {
        if (event) {
          event.stopPropagation();
          event.preventDefault();
        }
        // Remove unreleased section from data
        const unreleasedIndex = editHistoryData.findIndex(s => s.version === 'Unreleased' || s.version === 'Unreleased Draft');
        if (unreleasedIndex !== -1) {
          editHistoryData.splice(unreleasedIndex, 1);
          // Set first item of next version (V2) as viewing
          if (editHistoryData.length > 0 && editHistoryData[0].items.length > 0) {
            editHistoryData[0].items[0].viewing = true;
          }
          renderEditHistory();
        }
      }
      
      function toggleEditHistoryPanel() {
        if (!editHistoryPanel) return;
        const isOpen = editHistoryPanel.classList.contains('open');
        if (!isOpen) {
          renderEditHistory();
        }
        editHistoryPanel.classList.toggle('open', !isOpen);
      }
      
      if (editHistoryBtn) {
        editHistoryBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleEditHistoryPanel();
        });
      }
      
      // Close panel when clicking outside
      document.addEventListener('click', (e) => {
        if (editHistoryPanel && editHistoryPanel.classList.contains('open')) {
          if (!editHistoryPanel.contains(e.target) && e.target !== editHistoryBtn) {
            editHistoryPanel.classList.remove('open');
          }
        }
      });
    </script>
    <script>
      // Share Panel
      const shareBtn = document.getElementById('shareBtn');
      const sharePanel = document.getElementById('sharePanel');
      const shareClose = document.getElementById('shareClose');
      const shareVisibilityToggle = document.getElementById('shareVisibilityToggle');
      const shareVisibilityLabel = document.getElementById('shareVisibilityLabel');
      const shareUrlSection = document.getElementById('shareUrlSection');
      const shareUrlInput = document.getElementById('shareUrlInput');
      const shareCopyBtn = document.getElementById('shareCopyBtn');
      
      // Default to public
      let isPublic = true;
      
      function toggleSharePanel() {
        if (!sharePanel) return;
        const isOpen = sharePanel.classList.contains('open');
        // Close other panels
        document.querySelectorAll('.share-panel.open, .edit-history-panel.open').forEach(panel => {
          if (panel !== sharePanel) panel.classList.remove('open');
        });
        sharePanel.classList.toggle('open', !isOpen);
      }
      
      function updateShareVisibility() {
        isPublic = shareVisibilityToggle.checked;
        if (isPublic) {
          shareVisibilityLabel.textContent = 'Public';
          shareUrlSection.classList.remove('hidden');
        } else {
          shareVisibilityLabel.textContent = 'Private';
          shareUrlSection.classList.add('hidden');
        }
      }
      
      function copyShareUrl() {
        if (!shareUrlInput) return;
        shareUrlInput.select();
        shareUrlInput.setSelectionRange(0, 99999); // For mobile devices
        try {
          document.execCommand('copy');
          shareCopyBtn.textContent = 'Copied!';
          shareCopyBtn.classList.add('copied');
          setTimeout(() => {
            shareCopyBtn.textContent = 'Copy';
            shareCopyBtn.classList.remove('copied');
          }, 2000);
        } catch (err) {
          // Fallback for modern browsers
          navigator.clipboard.writeText(shareUrlInput.value).then(() => {
            shareCopyBtn.textContent = 'Copied!';
            shareCopyBtn.classList.add('copied');
            setTimeout(() => {
              shareCopyBtn.textContent = 'Copy';
              shareCopyBtn.classList.remove('copied');
            }, 2000);
          });
        }
      }
      
      if (shareBtn) {
        shareBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleSharePanel();
        });
      }
      
      if (shareClose) {
        shareClose.addEventListener('click', (e) => {
          e.stopPropagation();
          if (sharePanel) sharePanel.classList.remove('open');
        });
      }
      
      if (shareVisibilityToggle) {
        shareVisibilityToggle.addEventListener('change', updateShareVisibility);
        // Initialize
        updateShareVisibility();
      }
      
      if (shareCopyBtn) {
        shareCopyBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          copyShareUrl();
        });
      }
      
      // Close panel when clicking outside
      document.addEventListener('click', (e) => {
        if (sharePanel && sharePanel.classList.contains('open')) {
          const shareDD = sharePanel.closest('.share-dd');
          if (!shareDD || !shareDD.contains(e.target)) {
            sharePanel.classList.remove('open');
          }
        }
      });
    </script>
  </body>
</html>
