<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Alva · Playbook Detail</title>
    <meta http-equiv="refresh" content="0;url=playbook_strategy.html" />
    <style>
      :root { --bg: #ffffff; --panel: #f8fafc; --text: #111827; --muted: #6b7280; --accent: #14b8a6; --border: #e5e7eb; }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body { margin: 0; display: grid; grid-template-columns: 260px 1fr; grid-template-rows: 1fr; grid-template-areas: "sidebar main"; background: var(--bg); color: var(--text); font: 14px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
      body.subnav-open { grid-template-columns: 260px 220px 1fr; grid-template-rows: 1fr; grid-template-areas: "sidebar subnav main"; }
      body.sidebar-collapsed { grid-template-columns: 60px 1fr; }
      body.sidebar-collapsed.subnav-open { grid-template-columns: 60px 220px 1fr; }
      body.sidebar-collapsed .name, body.sidebar-collapsed .nav-top, body.sidebar-collapsed .nav-scroll, body.sidebar-collapsed .nav-bottom, body.sidebar-collapsed .nav-new-chat { display: none; }
      body.sidebar-collapsed .icon-rail { display: flex; }

      aside { grid-area: sidebar; height: 100vh; position: sticky; top: 0; border-right: 1px solid #3a3a48; background: #2A2A38; padding: 12px 10px; display: flex; flex-direction: column; gap: 12px; overflow: hidden; }
      nav { display: flex; flex-direction: column; gap: 12px; height: 100%; }
      .nav-new-chat { padding: 0 6px 6px; }
      .new-chat-btn { width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid #e5e7eb; background: #f8fafc; color: #111827; border-radius: 10px; padding: 8px 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
      .new-chat-btn:hover { background: #ffffff; }
      .new-chat-btn svg { width: 14px; height: 14px; fill: #374151; }
      .nav-top { padding: 4px 0; }
      .nav-scroll { flex: 1; overflow-y: auto; padding-right: 4px; }
      .nav-bottom { padding-top: 12px; border-top: 1px solid #3a3a48; position: sticky; bottom: 0; background: #2A2A38; }
      .side-brand { display: flex; align-items: center; gap: 8px; padding: 6px 8px; font-weight: 800; letter-spacing: 0.8px; }
      .side-brand .logo { width: 20px; height: 20px; border-radius: 6px; background: linear-gradient(135deg, var(--accent), #16a34a); box-shadow: 0 0 0 1px #0b5d31 inset; }
      .side-brand .name { font-size: 13px; color: #e5e7eb; }
      .collapse-btn { margin-left: auto; border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; width: 24px; height: 24px; line-height: 22px; text-align: center; cursor: pointer; }
      .collapse-btn:hover { border-color: #14b8a6; }
      .icon-rail { display: none; flex-direction: column; gap: 6px; padding: 0 6px; }
      .rail-btn { height: 36px; border-radius: 8px; border: 1px solid var(--border); background: #ffffff; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; }
      .rail-btn:hover { border-color: #24513b; }
      .rail-btn svg { width: 18px; height: 18px; fill: #a7f3d0; opacity: 0.9; }
      .section { display: flex; flex-direction: column; gap: 6px; }
      .section-title { font-size: 11px; text-transform: uppercase; color: var(--muted); letter-spacing: 0.6px; padding: 0 6px; }
      .section-title-row { display: flex; align-items: center; justify-content: space-between; }
      .title-plus { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 6px; width: 20px; height: 20px; font-size: 14px; line-height: 18px; text-align: center; cursor: pointer; }
      .title-plus:hover { border-color: #14b8a6; color: #0f766e; }
      .with-divider { border-top: 1px solid #182030; padding-top: 8px; margin-top: 4px; }
      ul { list-style: none; margin: 0; padding: 0; }
      li { display: block; }
      a { display: flex; align-items: center; gap: 8px; padding: 6px 8px; margin: 1px 0; border-radius: 8px; color: var(--text); text-decoration: none; transition: background 0.2s ease, color 0.2s ease; }
      a:hover { background: #e2e8f0; }
      aside a { color: #e5e7eb; }
      aside a:hover { background: rgba(255,255,255,0.06); color: #ffffff; }
      aside a.active { background: rgba(255,255,255,0.10); color: #ffffff; }
      aside .section-title { color: #cbd5e1; }
      aside .badge, aside .more { color: #9ca3af; }
      .badge { margin-left: auto; font-size: 10px; color: var(--muted); }
      .more { color: var(--muted); }
      .more:hover { color: var(--text); }
      .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); display: inline-block; margin-left: 6px; box-shadow: 0 0 0 2px #ffffff; }

      .subnav { grid-area: subnav; height: 100vh; position: sticky; top: 0; border-right: 1px solid var(--border); background: #ffffff; display: none; flex-direction: column; }
      .subnav a { color: #111827; }
      .subnav a:hover { background: #f1f5f9; color: #111827; }
      body.subnav-open .subnav { display: flex; }
      .subnav-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-bottom: 1px solid var(--border); }
      .subnav-title { font-size: 13px; font-weight: 600; }
      .subnav-content { flex: 1; overflow-y: auto; padding: 8px 10px; }
      .subnav-content ul { display: flex; flex-direction: column; gap: 4px; }
      .subnav-close { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 6px; padding: 4px 8px; }

      main { grid-area: main; padding: 16px; }
      .detail { display: grid; grid-template-columns: 1fr 360px; gap: 16px; }
      .paper { background: #ffffff; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .paper .hd { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
      .paper .bd { padding: 12px 14px; }
      .tabs { display: flex; gap: 8px; }
      .tab { padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); background: #ffffff; color: var(--text); font-size: 12px; cursor: pointer; }
      .tab.active { border-color: #14b8a6; color: #0f766e; }
      .title { font-weight: 700; }
      .objective { margin-bottom: 12px; }
      .feat-list { display: grid; gap: 8px; }
      .feat-item { display: grid; grid-template-columns: 1fr 28px 28px; align-items: center; gap: 8px; padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .feat-name { font-weight: 600; }
      .feat-desc { color: var(--muted); font-size: 12px; }
      .icon-btn { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; height: 28px; }
      .section-title-line { font-weight: 700; margin: 12px 0 8px; }
      .kv { display: grid; grid-template-columns: 160px 1fr; gap: 8px; margin: 6px 0; }
      .kv .k { color: var(--muted); }
      .bullet { margin: 6px 0; }
      .cfg-card { background: #ffffff; border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .cfg-card h3 { margin: 0 0 6px; font-size: 16px; }
      .btn-activate { width: 100%; border: 1px solid #14b8a6; background: #ecfdf5; color: #0f766e; border-radius: 8px; padding: 10px; margin-top: 8px; }
      .toggle { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; padding: 6px 10px; }
      .paper.collapsed .bd { display: none; }
      .detail.right-collapsed { grid-template-columns: 1fr max-content; }
      .detail.right-collapsed #configPanel { overflow: visible; background: transparent; border: 0; box-shadow: none; }
      .detail.right-collapsed #configPanel .title { display: none; }
      .detail.right-collapsed #configPanel .bd { display: none; }
      .detail.right-collapsed #configPanel .hd { padding: 12px 14px; justify-content: center; }
      .detail.right-collapsed #configPanel .toggle { padding: 4px; border: 0; background: transparent; position: relative; }
      .detail.right-collapsed #configPanel .toggle:hover::after { content: attr(data-tip); position: absolute; left: 50%; top: calc(100% + 8px); transform: translateX(-50%); background: #ffffff; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 6px 8px; white-space: nowrap; box-shadow: 0 8px 16px rgba(0,0,0,0.12); z-index: 10; }
      .orb { display: inline-block; width: 28px; height: 28px; border-radius: 50%; background: radial-gradient(circle at 35% 30%, #a7f3d0 0%, #22c55e 35%, #16a34a 65%, #0b1220 100%); box-shadow: 0 0 12px rgba(34,197,94,0.6), inset 0 0 8px rgba(11,93,49,0.6); }
      @keyframes orbPulse { from { box-shadow: 0 0 8px rgba(34,197,94,0.4), inset 0 0 4px rgba(11,93,49,0.4); } to { box-shadow: 0 0 14px rgba(34,197,94,0.8), inset 0 0 8px rgba(11,93,49,0.7); } }
      .orb { animation: orbPulse 2.6s ease-in-out infinite alternate; }
      .chat-list { display: flex; flex-direction: column; gap: 8px; max-height: 32vh; overflow: auto; margin-top: 8px; }
      .chat-msg { display: grid; grid-template-columns: 64px 1fr; gap: 10px; padding: 8px; border: 1px solid var(--border); border-radius: 10px; background: #ffffff; }
      .chat-role { color: var(--muted); }
      .msg-ai { background: #ffffff; }
      .msg-you { background: #f8fafc; }
      #configPanel .bd { display: flex; flex-direction: column; }
      .chat-box { display: flex; flex-direction: column; margin-top: auto; }
      .chat-compose { display: grid; grid-template-columns: 1fr 110px; gap: 10px; margin-top: 8px; padding: 8px; background: #f8fafc; border-top: 1px solid var(--border); border-radius: 0 0 12px 12px; }
      .chat-input { width: 100%; border: 1px solid var(--border); border-radius: 10px; background: #ffffff; color: var(--text); padding: 13px 14px; }
      .chat-send { border: 1px solid #14b8a6; background: #ecfdf5; color: #0f766e; border-radius: 8px; }

      .hidden { display: none; }
      .feature-analytics { display: grid; gap: 10px; }
      .last-updated { color: var(--muted); font-size: 12px; }
      .chart-container { background: #ffffff; border: 1px solid var(--border); border-radius: 10px; padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .chart-container h4 { margin: 0 0 6px; font-size: 14px; }
      .chart-skeleton { height: 160px; border-radius: 8px; background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 37%, #f3f4f6 63%); background-size: 400% 100%; animation: shimmer 1.8s ease-in-out infinite; }
      @keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }
      .overview-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
      .metrics-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin: 8px 0 12px; }
      .metric-card { background: #ffffff; border: 1px solid var(--border); border-radius: 10px; padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .metric-title { color: var(--muted); font-size: 12px; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
      .metric-value { font-weight: 700; color: #22c55e; margin-bottom: 6px; }
      .sparkline-skel { height: 42px; border-radius: 8px; background: linear-gradient(90deg, #0b1220 25%, #0d1422 37%, #0b1220 63%); background-size: 400% 100%; animation: shimmer 1.8s ease-in-out infinite; }
      .equity-card { background: #ffffff; border: 1px solid var(--border); border-radius: 10px; padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .equity-hd { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
      .equity-title { font-weight: 700; }
      .currency-dd { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; padding: 4px 8px; font-size: 12px; }
      .equity-legend { display: flex; align-items: center; gap: 12px; color: var(--muted); font-size: 12px; margin-bottom: 8px; }
      .legend-item { display: flex; align-items: center; gap: 6px; }
      .legend-swatch { width: 10px; height: 10px; border-radius: 2px; display: inline-block; }
      .swatch-gray { background: #6b7280; }
      .swatch-purple { background: #7c3aed; }
      .swatch-orange { background: #f59e0b; }
      .equity-skeleton { height: 280px; border-radius: 8px; background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 37%, #f3f4f6 63%); background-size: 400% 100%; animation: shimmer 1.8s ease-in-out infinite; }
      .traded-symbols { margin-top: 12px; }
      .symbol-row { display: grid; grid-template-columns: 1fr max-content; align-items: center; gap: 8px; padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .symbol-name { font-weight: 700; }
      .symbol-extra { color: var(--muted); font-size: 12px; display: flex; align-items: center; gap: 6px; }
      .feed-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
      .asset-left { display: flex; align-items: center; gap: 8px; }
      .asset-pill { display: inline-flex; align-items: center; gap: 6px; border: 1px solid var(--border); background: #0e1626; color: #a7f3d0; border-radius: 999px; padding: 4px 8px; font-size: 12px; }
      .asset-name { font-weight: 700; }
      .asset-extra { color: var(--muted); font-size: 12px; }
      .asset-right { color: var(--muted); font-size: 12px; display: flex; align-items: center; gap: 6px; }
      .kline-card { background: #ffffff; border: 1px solid var(--border); border-radius: 10px; height: 320px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .spinner { width: 44px; height: 44px; border: 4px solid #e5e7eb; border-top-color: #a7f3d0; border-right-color: #a7f3d0; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .feed-list { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
      .feed-item { display: grid; grid-template-columns: 40px 1fr max-content; gap: 10px; padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .avatar { width: 28px; height: 28px; border-radius: 50%; background: #1f2937; }
      .feed-title { font-weight: 700; }
      .feed-tag { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
      .feed-change { color: #22c55e; font-weight: 700; }
      .feed-sub { color: var(--muted); font-size: 12px; }
      .feed-time { color: var(--muted); font-size: 12px; }
    
      .search-overlay { position: fixed; inset: 0; background: rgba(2,8,23,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
      .search-overlay.open { display: flex; }
      .search-modal { width: min(760px, 92vw); border-radius: 12px; background: #ffffff; border: 1px solid var(--border); box-shadow: 0 12px 32px rgba(0,0,0,0.12); }
      .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); }
      .modal-title { font-weight: 700; }
      .modal-close { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; padding: 6px 10px; }
      .modal-body { padding: 12px 14px; }
      .modal-input { width: 100%; border: 1px solid var(--border); border-radius: 10px; background: #ffffff; color: #111827; padding: 10px 12px; margin-bottom: 12px; }
      .entity-list { display: flex; flex-direction: column; gap: 6px; max-height: 60vh; overflow: auto; }
      .entity-row { display: grid; grid-template-columns: 80px 1fr 90px 100px; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; }
      .entity-row:hover { background: #f8fafc; }
      .sym { font-weight: 600; letter-spacing: 0.4px; }
      .type { color: var(--muted); font-size: 12px; }
      .exch { color: #a7f3d0; font-size: 12px; }
      .me-icons .icon-btn { width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; }
      .icon-btn svg { width: 16px; height: 16px; fill: #a7f3d0; opacity: 0.9; }
      .chart-canvas { width: 100%; height: 160px; display: block; }
      .equity-canvas { width: 100%; height: 280px; display: block; }
      .sparkline-canvas { width: 100%; height: 42px; display: block; }
      .nav-popover { position: fixed; top: 70px; left: 260px; width: 380px; border-radius: 12px; background: #ffffff; border: 1px solid var(--border); box-shadow: 0 16px 40px rgba(0,0,0,0.12); display: none; z-index: 900; }
      .nav-popover.open { display: block; }
      .nav-popover .pop-hd { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); font-weight: 700; }
      .nav-popover .pop-bd { padding: 12px 14px; }
      .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
      .action-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 10px; padding: 14px 8px; cursor: pointer; text-decoration: none; }
      .action-btn:hover { border-color: #cbd5e1; }
      .act-ico { width: 30px; height: 30px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; }
      .act-ico svg { width: 18px; height: 18px; }
      .ico-blue { background: #0b3a55; }
      .ico-orange { background: #5a3a0b; }
      .ico-green { background: #0b3a2a; }
      .ico-purple { background: #3a0b55; }
      .label { font-size: 13px; color: #374151; font-weight: 600; }
      .popover-close { border: 1px solid var(--border); background: #ffffff; color: var(--text); border-radius: 8px; padding: 6px 10px; }
    </style>
  </head>
  <body>
    <aside>
      <div class="side-brand"><div class="logo"></div><div class="name">ALVA</div><button id="sidebarToggle" class="collapse-btn" aria-label="Collapse Navigation">«</button></div>
      <div class="icon-rail">
        <a class="rail-btn" href="index.html" title="Home" aria-label="Home">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3l9-8z"/></svg>
        </a>
        <a class="rail-btn" href="explore.html" title="Explore" aria-label="Explore">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M16 11c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm-8 0c1.657 0 3-1.343 3-3S9.657 5 8 5 5 6.343 5 8s1.343 3 3 3zm0 2c-2.761 0-5 1.79-5 4v2h10v-2c0-2.21-2.239-4-5-4zm8 0c-.738 0-1.429.131-2.061.362A5.97 5.97 0 0119 17v2h5v-2c0-2.21-2.239-4-5-4z"/></svg>
        </a>
      <a class="rail-btn" href="#search" title="Search" aria-label="Search">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 2a8 8 0 105.293 14.293l4.707 4.707 1.414-1.414-4.707-4.707A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/></svg>
      </a>
      <a class="rail-btn" href="playbook.html" title="Starred" aria-label="Starred">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
      </a>
      <a class="rail-btn" href="playbook.html" title="Playbooks" aria-label="Playbooks">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M18 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12V2zm-2 14H8v-2h8v2zm0-4H8V8h8v4z"/></svg>
      </a>
      <a class="rail-btn" href="#threads-more" title="Threads" aria-label="Threads">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M4 4h16v10H5.17L4 15.17V4zm0 12h12v4H4v-4z"/></svg>
      </a>
      </div>
      <nav>
        <div class="nav-new-chat">
          <button id="newChatBtn" class="new-chat-btn" aria-label="New Playbook">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 5v14m-7-7h14" stroke="#374151" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            New Playbook
          </button>
        </div>
        <div class="nav-top">
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="explore.html">Explore</a></li>
            <li><a href="#search">Search</a></li>
            <li>
              <a href="https://stg.alva.xyz/landing" target="_blank" rel="noopener noreferrer">
                <span>About</span>
                <span class="nav-external-icon" aria-hidden="true">
                  <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 5h6v6" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 11l6-6" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
              </a>
            </li>
          </ul>
        </div>
        <div class="nav-scroll">
          <div class="section with-divider">
            <div class="section-title">Starred</div>
            <ul>
              <li><a href="playbook.html">Dashboard-Playbook A</a></li>
              <li><a href="playbook.html">Strategy-Playbook B</a></li>
              <li><a href="playbook.html">Research-Playbook C</a></li>
              <li><a class="more" href="#starred-more">··· More</a></li>
            </ul>
          </div>
          <div class="section with-divider">
            <div class="section-title section-title-row"><span>Playbooks</span></div>
            <ul>
              <li><a href="playbook.html">Dashboard-Playbook A</a></li>
              <li><a href="playbook.html">Strategy-Playbook B</a></li>
              <li><a href="playbook.html">Research-Playbook C</a></li>
              <li><a class="more" href="#library-playbooks-more">··· More</a></li>
            </ul>
          </div>
          <div class="section with-divider">
            <div class="section-title section-title-row"><span>Threads</span></div>
            <ul>
              <li><a href="#threads-a">Thread A</a></li>
              <li><a href="#threads-b">Thread B</a></li>
              <li><a href="#threads-c">Thread C</a></li>
              <li><a class="more" href="#threads-more">··· More</a></li>
            </ul>
          </div>
        </div>
        <div class="nav-bottom">
          <div class="me-icons">
            <button class="icon-btn" title="Profile" aria-label="Profile">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zm0 2c-3.866 0-7 2.239-7 5v2h14v-2c0-2.761-3.134-5-7-5z"/></svg>
            </button>
            <button class="icon-btn" title="Settings" aria-label="Settings">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M19.14 12.936a7.97 7.97 0 000-1.872l2.037-1.58a.5.5 0 00.12-.64l-1.93-3.343a.5.5 0 00-.6-.22l-2.4.96a7.968 7.968 0 00-1.62-.94l-.36-2.54a.5.5 0 00-.5-.43h-3.86a.5.5 0 00-.5.43l-.36 2.54a7.968 7.968 0 00-1.62.94l-2.4-.96a.5.5 0 00-.6.22L2.7 8.844a.5.5 0 00.12.64l2.037 1.58a7.97 7.97 0 000 1.872L2.82 14.516a.5.5 0 00-.12.64l1.93 3.343a.5.5 0 00.6.22l2.4-.96c.5.38 1.05.7 1.62.94l.36 2.54a.5.5 0 00.5.43h3.86a.5.5 0 00.5-.43l.36-2.54c.57-.24 1.12-.56 1.62-.94l2.4.96a.5.5 0 00.6-.22l1.93-3.343a.5.5 0 00-.12-.64l-2.037-1.58zM12 15a3 3 0 110-6 3 3 0 010 6z"/></svg>
            </button>
          </div>
        </div>
      </nav>
    </aside>
    <aside class="subnav">
      <div class="subnav-header"><div class="subnav-title">More</div><button class="subnav-close" type="button">Close</button></div>
      <div id="subnav-content" class="subnav-content"></div>
    </aside>
    <div id="searchOverlay" class="search-overlay">
      <div class="search-modal">
        <div class="modal-header">
          <div class="modal-title">Search</div>
          <button id="searchClose" class="modal-close">X</button>
        </div>
        <div class="modal-body">
          <input id="searchInput" class="modal-input" placeholder="Try symbol, e.g. AAPL" />
          <div id="entityList" class="entity-list"></div>
        </div>
      </div>
    </div>
    <div id="navPopover" class="nav-popover" role="dialog" aria-label="New Playbook">
      <div class="pop-hd"><div>New Playbook</div><button id="popoverClose" class="popover-close">Close</button></div>
      <div class="pop-bd">
        <div class="action-grid">
          <a href="#" class="action-btn" data-act="dashboard"><span class="act-ico ico-orange"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#f59e0b" d="M3 3h8v8H3V3zm10 0h8v5h-8V3zm0 7h8v11h-8V10zm-10 4h8v7H3v-7z"/></svg></span><span class="label">Dashboard</span></a>
          <a href="#" class="action-btn" data-act="strategy"><span class="act-ico ico-green"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#34d399" d="M12 2l4 8H8l4-8zm-6 18h12v2H6v-2zm1-8h10v2H7v-2z"/></svg></span><span class="label">Trading Strategy</span></a>
          <a href="#" class="action-btn" data-act="research"><span class="act-ico ico-purple"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#a78bfa" d="M12 3l9 4-9 4-9-4 9-4zm0 6l9 4-9 4-9-4 9-4zm0 8l9 4-9 4-9-4 9-4z"/></svg></span><span class="label">Agentic Research</span></a>
        </div>
      </div>
    </div>
    <script src="nav.js"></script>
    <script>
      (function() {
        const searchOverlay = document.getElementById('searchOverlay');
        const searchClose = document.getElementById('searchClose');
        const searchInput = document.getElementById('searchInput');
        const entityList = document.getElementById('entityList');
        const searchLinks = Array.from(document.querySelectorAll('a[href="#search"]'));
        const entities = [
          { sym: 'ETH', name: 'Ethereum', type: 'CRYPTO', exch: 'Binance' },
          { sym: 'BTC', name: 'Bitcoin', type: 'CRYPTO', exch: 'Binance' },
          { sym: 'NVDA', name: 'NVIDIA Corporation', type: 'STOCK', exch: 'NASDAQ' }
        ];
        function renderEntities(filter = '') {
          const q = filter.trim().toLowerCase();
          const data = entities.filter(e => !q || e.sym.toLowerCase().includes(q) || e.name.toLowerCase().includes(q));
          entityList.innerHTML = data.map(e => `<div class="entity-row"><div class="sym">${e.sym}</div><div class="name">${e.name}</div><div class="type">${e.type}</div><div class="exch">${e.exch}</div></div>`).join('');
        }
        function openSearch() { searchOverlay.classList.add('open'); renderEntities(''); searchInput.value=''; searchInput.focus(); }
        function closeSearch() { searchOverlay.classList.remove('open'); }
        searchLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); openSearch(); }));
        searchClose.addEventListener('click', closeSearch);
        searchOverlay.addEventListener('click', (e) => { if (e.target === searchOverlay) closeSearch(); });
        document.addEventListener('keydown', (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); openSearch(); }
          if (e.key === 'Escape') closeSearch();
        });
        searchInput.addEventListener('input', () => renderEntities(searchInput.value));
      })();
    </script>
    <main>
      <div class="detail">
        <div class="paper">
          <div class="hd">
            <div class="title">BTC Weekly MA7—MA25 Crossover Allocator</div>
            <div class="tabs"><span class="tab active" data-target="overview">Overview</span><span class="tab" data-target="analytics">Analytics</span><span class="tab" data-target="strategy">Strategy</span><span class="tab" data-target="feed">Feed</span></div>
          </div>
          <div class="bd">
            <div id="pane-overview" class="tab-pane">
              <div class="overview-header">
                <div class="section-title-line">Performance Overview</div>
                <div class="last-updated">Last Updated: 11/28/2025 · Interval: 1w</div>
              </div>
              <div class="metrics-grid">
                <div class="metric-card"><div class="metric-title">Total Return</div><div class="metric-value">7.06%</div><div class="sparkline-skel"></div></div>
                <div class="metric-card"><div class="metric-title">Annualized Return</div><div class="metric-value">3.48%</div><div class="sparkline-skel"></div></div>
                <div class="metric-card"><div class="metric-title">Volatility</div><div class="metric-value">67.64%</div><div class="sparkline-skel"></div></div>
                <div class="metric-card"><div class="metric-title">Sharpe Ratio</div><div class="metric-value">0.68</div><div class="sparkline-skel"></div></div>
                <div class="metric-card"><div class="metric-title">Sortino Ratio</div><div class="metric-value">1.04</div><div class="sparkline-skel"></div></div>
                <div class="metric-card"><div class="metric-title">Max Drawdown</div><div class="metric-value">25.27%</div><div class="sparkline-skel"></div></div>
              </div>
              <div class="equity-card">
                <div class="equity-hd"><div class="equity-title">Equity Curve</div><div class="currency-dd">USD ▾</div></div>
                <div class="equity-legend">
                  <div class="legend-item"><span class="legend-swatch swatch-gray"></span>Initial Amount</div>
                  <div class="legend-item"><span class="legend-swatch swatch-purple"></span>This Playbook</div>
                  <div class="legend-item"><span class="legend-swatch swatch-orange"></span>BTC</div>
                </div>
                <div class="equity-skeleton"></div>
              </div>
              <div class="traded-symbols">
                <div class="section-title-line">Traded Symbols</div>
                <div class="symbol-row"><div><div class="symbol-name">Bitcoin</div><div class="symbol-extra">0 USD</div></div><div class="symbol-extra">Binance ↗</div></div>
              </div>
            </div>
            <div id="pane-analytics" class="tab-pane hidden">
              <div class="feature-analytics">
                <div class="section-title-line">Feature Analytics</div>
                <div class="last-updated">Last Updated: 12/6/2025 · Interval: 1w</div>
                <div class="chart-container">
                  <h4>Btc Ma25 Prev</h4>
                  <div class="chart-skeleton"></div>
                </div>
                <div class="chart-container">
                  <h4>Btc Ma25 W</h4>
                  <div class="chart-skeleton"></div>
                </div>
              </div>
            </div>
            <div id="pane-strategy" class="tab-pane hidden">
              <div class="objective">Capture medium-term BTC/USD trends using weekly MA7/MA25 crossovers, switching between 100% long and cash-only exposure at weekly closes.</div>
              <div class="section-title-line">Features</div>
              <div class="feat-list">
                <div class="feat-item"><div><div class="feat-name">Btc Ma25 Prev</div><div class="feat-desc">Previous week value of the 25-period weekly SMA for detecting crossovers.</div></div><button class="icon-btn">=</button><button class="icon-btn">≡</button></div>
                <div class="feat-item"><div><div class="feat-name">Btc Ma25 W</div><div class="feat-desc">25-period simple moving average of weekly closing prices to represent medium-term trend.</div></div><button class="icon-btn">=</button><button class="icon-btn">≡</button></div>
                <div class="feat-item"><div><div class="feat-name">Btc Ma7 Prev</div><div class="feat-desc">Previous week value of the 7-period weekly SMA for detecting crossovers.</div></div><button class="icon-btn">=</button><button class="icon-btn">≡</button></div>
                <div class="feat-item"><div><div class="feat-name">Btc Ma7 W</div><div class="feat-desc">7-period simple moving average of weekly closing prices to represent short-term trend.</div></div><button class="icon-btn">=</button><button class="icon-btn">≡</button></div>
              </div>
              <div class="section-title-line">Strategy</div>
              <div class="kv"><div class="k">Trading Pairs</div><div>BINANCE_SPOT_BTC_USDT</div></div>
              <div class="kv"><div class="k">Interval</div><div>Weekly (1w) candles</div></div>
              <div class="kv"><div class="k">Backtest Period</div><div>1 year (up to 2 years for MA25 warm-up)</div></div>
              <div class="section-title-line">Signal Generation</div>
              <div class="bullet">Entry when short-term (MA7) bullishly crosses above medium-term (MA25) on weekly close.</div>
              <div class="bullet">Exit when MA7 bearishly crosses below MA25 on weekly close.</div>
            </div>
            <div id="pane-feed" class="tab-pane hidden">
              <div class="feed-header">
                <div class="asset-left">
                  <span class="asset-pill">BTC</span>
                  <div>
                    <div class="asset-name">Bitcoin</div>
                    <div class="asset-extra">0 USD</div>
                  </div>
                </div>
                <div class="asset-right">Binance ↗</div>
              </div>
              <div class="kline-card"><div class="spinner"></div></div>
              <div class="feed-list">
                <div class="feed-item">
                  <div class="avatar"></div>
                  <div>
                    <div class="feed-title">Leoz · BTC Weekly MA7—MA25 Crossover</div>
                    <div class="feed-tag"><span class="asset-pill">BTC</span><span class="feed-change">Increase from 0% → 100.00%</span><span>↗</span></div>
                    <div class="feed-sub">Bullish MA7/MA25 crossover</div>
                  </div>
                  <div class="feed-time">05/29/2025 08:00</div>
                </div>
                <div class="feed-item">
                  <div class="avatar"></div>
                  <div>
                    <div class="feed-title">Leoz · BTC Weekly MA7—MA25 Crossover</div>
                    <div class="feed-tag"><span class="asset-pill">BTC</span><span class="feed-change">Add & short from 0 → 100.00%</span></div>
                    <div class="feed-sub">Bullish MA7/MA25 crossover</div>
                  </div>
                  <div class="feed-time">10/31/2024 08:00</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="configPanel" class="paper">
          <div class="hd"><div class="title">chat</div><div><button id="panelToggle" class="toggle">▾</button></div></div>
          <div class="bd">
            <div class="bullet">Schedule: 00:00 UTC every Sunday on new weekly candle.</div>
            <div class="bullet">Start timestamp: 1701302400000</div>
            <div class="bullet">Initial capital: 1,000,000 (base currency)</div>
            <div class="bullet">Changelog: Initial strategy based on specified rules.</div>
            <div class="cfg-card">
              <h3>BTC Weekly MA7—MA25 Crossover Allocator</h3>
              <div class="bullet">Execution interval: 12:00 AM, only on Sunday</div>
              <div class="bullet">Backtest Results: totalReturn 70.6%, sharpeRatio 0.68</div>
              <button class="btn-activate">Activate</button>
            </div>
            <div class="chat-box">
              <div id="cfgChatList" class="chat-list"></div>
              <div class="chat-compose">
                <div class="chat-input-card">
                  <textarea id="cfgChatInput" class="chat-textarea" placeholder="Build an investing playbook from your ideas"></textarea>
                  <div id="mentionChipsContainer" class="mention-chips-container"></div>
                  <div id="addContextMenu" class="add-context-menu">
                    <div class="add-context-header">Add Context</div>
                    <div class="add-context-body" id="addContextBody"></div>
                  </div>
                  <div class="chat-toolbar">
                    <div class="build-btn-dd">
                      <button id="buildModeBtn" class="build-btn" type="button" data-mode="build">
                        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                          <path d="M2 12h12v2H2v-2zm0-8h2v6H2V4zm4 2h2v4H6V6zm4-4h2v8h-2V2z" fill="currentColor"/>
                        </svg>
                        Build
                        <span>▾</span>
                      </button>
                      <div id="buildMenu" class="build-menu">
                        <button class="build-menu-item" data-mode="ask">
                          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2a6 6 0 100 12A6 6 0 008 2zm0 1a5 5 0 110 10A5 5 0 008 3zm0 2a3 3 0 100 6 3 3 0 000-6zm0 1a2 2 0 110 4 2 2 0 010-4z" fill="currentColor"/>
                          </svg>
                          Ask
                        </button>
                        <button class="build-menu-item active" data-mode="build">
                          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 12h12v2H2v-2zm0-8h2v6H2V4zm4 2h2v4H6V6zm4-4h2v8h-2V2z" fill="currentColor"/>
                          </svg>
                          Build
                        </button>
                      </div>
                    </div>
                    <div class="toolbar-right">
                      <button id="chatAtBtn" class="toolbar-icon-btn" type="button" aria-label="Mention">@</button>
                      <button class="toolbar-icon-btn" type="button" aria-label="Upload image">
                        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                          <rect x="2" y="4" width="12" height="8" fill="none" stroke="currentColor" stroke-width="1"/>
                          <path d="M4 10l2-2 2 2 4-4 2 2v2H4z" fill="currentColor" opacity="0.6"/>
                          <circle cx="5" cy="6" r="0.8" fill="currentColor"/>
                        </svg>
                      </button>
                      <button id="cfgChatSend" class="toolbar-icon-btn send-btn" type="button" aria-label="Send">
                        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                          <path d="M2 8l12-6-6 6 6 6L2 8z" fill="currentColor"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <script>
      const moreHandlers = {
        '#starred-more': { title: 'Starred · More', items: Array.from({length: 12}, (_, i) => `Starred Item ${i+1}`) },
        '#library-playbooks-more': { title: 'Playbooks · More', items: Array.from({length: 12}, (_, i) => `Playbook Item ${i+1}`) },
        '#threads-more': { title: 'Threads · More', items: Array.from({length: 12}, (_, i) => `Thread Item ${i+1}`) },
      };
      document.querySelectorAll('a.more').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const isOpen = document.body.classList.contains('subnav-open');
          if (isOpen) { document.body.classList.remove('subnav-open'); return; }
          const key = a.getAttribute('href');
          const cfg = moreHandlers[key] || { title: 'More', items: [] };
          document.body.classList.add('subnav-open');
          const container = document.getElementById('subnav-content');
          container.innerHTML = `<ul>${cfg.items.map(item => `<li><a href=\"#\">${item}</a></li>`).join('')}</ul>`;
          document.querySelector('.subnav-title').textContent = cfg.title;
        });
      });
      document.querySelector('.subnav-close').addEventListener('click', () => { document.body.classList.remove('subnav-open'); });

      
      const configPanel = document.getElementById('configPanel');
      const panelToggle = document.getElementById('panelToggle');
      const detailGrid = document.querySelector('.detail');
      // New Playbook popover handled centrally in nav.js
      panelToggle.addEventListener('click', () => {
        const collapsed = detailGrid.classList.toggle('right-collapsed');
        if (collapsed) {
          panelToggle.innerHTML = '<span class="orb" aria-hidden="true"></span>';
          panelToggle.setAttribute('aria-label', 'Expand chat panel');
          panelToggle.setAttribute('data-tip', 'Chat with Alva！');
        } else {
          panelToggle.textContent = '▾';
          panelToggle.setAttribute('aria-label', 'Collapse chat panel');
          panelToggle.removeAttribute('data-tip');
        }
      });
      const sidebarToggle = document.getElementById('sidebarToggle');
      sidebarToggle.addEventListener('click', () => {
        const collapsed = document.body.classList.toggle('sidebar-collapsed');
        sidebarToggle.textContent = collapsed ? '»' : '«';
      });
      document.querySelectorAll('.icon-rail .rail-btn[aria-label="Starred"], .icon-rail .rail-btn[aria-label="Playbooks"], .icon-rail .rail-btn[aria-label="Threads"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const cfg = moreHandlers['#threads-more'];
          document.body.classList.add('subnav-open');
          const container = document.getElementById('subnav-content');
          container.innerHTML = `<ul>${cfg.items.map(item => `<li><a href=\"#\">${item}</a></li>`).join('')}</ul>`;
          document.querySelector('.subnav-title').textContent = cfg.title;
        });
      });
      
      const charts = [];
      function drawLineChart(cv, data, color) {
        const ctx = cv.getContext('2d');
        const ratio = window.devicePixelRatio || 1;
        const w = cv.parentElement.clientWidth || 600;
        const h = parseInt(cv.dataset.h || (cv.classList.contains('equity-canvas') ? 280 : 160), 10);
        cv.width = w * ratio;
        cv.height = h * ratio;
        cv.style.width = '100%';
        cv.style.height = h + 'px';
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
        ctx.clearRect(0, 0, w, h);
        if (!data || !data.length) return;
        let min = Math.min.apply(null, data);
        let max = Math.max.apply(null, data);
        if (min === max) { min -= 1; max += 1; }
        const pad = 10;
        const xStep = (w - pad * 2) / (data.length - 1);
        ctx.lineWidth = 2;
        ctx.strokeStyle = color || '#22c55e';
        ctx.beginPath();
        data.forEach((v, i) => {
          const x = pad + xStep * i;
          const y = pad + (h - pad * 2) * (1 - (v - min) / (max - min));
          if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }
      function drawKline(cv, candles) {
        const ctx = cv.getContext('2d');
        const ratio = window.devicePixelRatio || 1;
        const w = cv.parentElement.clientWidth || 600;
        const h = 320;
        cv.width = w * ratio;
        cv.height = h * ratio;
        cv.style.width = '100%';
        cv.style.height = h + 'px';
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
        ctx.clearRect(0, 0, w, h);
        const pad = 12;
        const bodyW = Math.max(3, Math.floor((w - pad * 2) / candles.length * 0.5));
        const lows = candles.map(c => c.l);
        const highs = candles.map(c => c.h);
        const min = Math.min.apply(null, lows);
        const max = Math.max.apply(null, highs);
        const scaleY = v => pad + (h - pad * 2) * (1 - (v - min) / (max - min));
        candles.forEach((c, i) => {
          const x = pad + i * ((w - pad * 2) / candles.length) + (((w - pad * 2) / candles.length) / 2);
          const yOpen = scaleY(c.o);
          const yClose = scaleY(c.c);
          const yHigh = scaleY(c.h);
          const yLow = scaleY(c.l);
          const up = c.c >= c.o;
          ctx.strokeStyle = up ? '#16a34a' : '#ef4444';
          ctx.fillStyle = up ? '#22c55e' : '#ef4444';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x, yHigh);
          ctx.lineTo(x, yLow);
          ctx.stroke();
          const yTop = Math.min(yOpen, yClose);
          const yBottom = Math.max(yOpen, yClose);
          ctx.fillRect(x - bodyW / 2, yTop, bodyW, Math.max(1, yBottom - yTop));
        });
      }
      function setupCharts() {
        const equitySkel = document.querySelector('.equity-skeleton');
        if (equitySkel) {
          const canvas = document.createElement('canvas');
          canvas.className = 'equity-canvas';
          equitySkel.replaceWith(canvas);
          const equityData = [100, 102, 104, 103, 106, 110, 108, 112, 115, 118, 117, 120, 124, 129, 127, 132];
          charts.push(() => drawLineChart(canvas, equityData, '#22c55e'));
        }
        document.querySelectorAll('.chart-container .chart-skeleton').forEach((skel, idx) => {
          const canvas = document.createElement('canvas');
          canvas.className = 'chart-canvas';
          canvas.dataset.h = '160';
          skel.replaceWith(canvas);
          const series = idx % 2 === 0 ? [30,32,31,35,34,36,38,37,39,41,40,42] : [12,11,13,12,14,13,15,16,15,17,18,17];
          const color = idx % 2 === 0 ? '#7c3aed' : '#f59e0b';
          charts.push(() => drawLineChart(canvas, series, color));
        });
        document.querySelectorAll('.metrics-grid .sparkline-skel').forEach(skel => {
          const cv = document.createElement('canvas');
          cv.className = 'sparkline-canvas';
          cv.dataset.h = '42';
          skel.replaceWith(cv);
          const series = Array.from({length: 24}, (_, i) => 50 + Math.sin(i / 2.2) * 6 + (i % 4) - (i % 5) * 0.4);
          charts.push(() => drawLineChart(cv, series, '#22c55e'));
        });
        const klineCard = document.querySelector('.kline-card');
        if (klineCard) {
          klineCard.innerHTML = '';
          const canvas = document.createElement('canvas');
          klineCard.appendChild(canvas);
          const candles = [
            {o:100,h:104,l:98,c:102},{o:102,h:105,l:100,c:104},{o:104,h:106,l:102,c:103},{o:103,h:107,l:101,c:106},
            {o:106,h:110,l:104,c:108},{o:108,h:111,l:106,c:110},{o:110,h:113,l:108,c:112},{o:112,h:115,l:110,c:114},
            {o:114,h:116,l:112,c:113},{o:113,h:117,l:111,c:116},{o:116,h:120,l:114,c:118},{o:118,h:121,l:116,c:119}
          ];
          charts.push(() => drawKline(canvas, candles));
        }
        charts.forEach(fn => fn());
      }
      window.addEventListener('resize', () => { charts.forEach(fn => fn()); });
      setupCharts();
      const cfgChatList = document.getElementById('cfgChatList');
      const cfgChatInput = document.getElementById('cfgChatInput');
      const cfgChatSend = document.getElementById('cfgChatSend');
      const chatAtBtn = document.getElementById('chatAtBtn');
      const addContextMenu = document.getElementById('addContextMenu');
      const addContextBody = document.getElementById('addContextBody');
      
      function insertAtCursor(el, text) {
        const start = el.selectionStart || 0;
        const end = el.selectionEnd || 0;
        const val = el.value || '';
        el.value = val.slice(0, start) + text + val.slice(end);
        el.selectionStart = el.selectionEnd = start + text.length;
        el.focus();
        // Trigger input event to update mention chips (this will call renderMentionChips)
        el.dispatchEvent(new Event('input', { bubbles: true }));
        // Also call directly to ensure it runs
        setTimeout(() => renderMentionChips(), 0);
      }
      
      // Build button dropdown
      const buildModeBtn = document.getElementById('buildModeBtn');
      const buildMenu = document.getElementById('buildMenu');
      if (buildModeBtn && buildMenu) {
        buildModeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          buildMenu.classList.toggle('open');
        });
        buildMenu.querySelectorAll('.build-menu-item').forEach(item => {
          item.addEventListener('click', () => {
            const mode = item.getAttribute('data-mode');
            buildModeBtn.setAttribute('data-mode', mode);
            const label = mode === 'ask' ? 'Ask' : 'Build';
            const ico = mode === 'ask'
              ? '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 2a6 6 0 100 12A6 6 0 008 2zm0 1a5 5 0 110 10A5 5 0 008 3zm0 2a3 3 0 100 6 3 3 0 000-6zm0 1a2 2 0 110 4 2 2 0 010-4z" fill="currentColor"/></svg>'
              : '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M2 12h12v2H2v-2zm0-8h2v6H2V4zm4 2h2v4H6V6zm4-4h2v8h-2V2z" fill="currentColor"/></svg>';
            buildModeBtn.innerHTML = ico + ' ' + label + ' <span>▾</span>';
            buildMenu.querySelectorAll('.build-menu-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            buildMenu.classList.remove('open');
            if (mode === 'ask') {
              cfgChatInput.placeholder = 'Ask anything about investing';
            } else {
              cfgChatInput.placeholder = 'Build an investing playbook from your ideas';
            }
          });
        });
        document.addEventListener('click', (e) => {
          const dd = buildModeBtn.closest('.build-btn-dd');
          if (dd && !dd.contains(e.target)) buildMenu.classList.remove('open');
        });
      }
      
      // Add Context menu data
      const contextData = {
        playbooks: [
          { label: 'Attribution Analysis Strategy for Price Trends', badge: 'Current', icon: 'chart' },
          { label: 'NVDA Price Fetcher', icon: 'chart' },
          { label: 'BTC Dip Mean-Reversion RSI Bollinger v2', icon: 'refresh' }
        ],
        threads: [
          { label: 'TSLA Financial Trends and Charts Analysis', icon: 'list' },
          { label: 'US Treasury Yield and Bitcoin Correlation Analysis', icon: 'list' }
        ],
        widgets: [
          { label: 'chart_nvda_revenue_qoq_yoy', icon: 'widget' },
          { label: 'chart_nvda_core_segments_trend', icon: 'widget' },
          { label: 'nvda_quarterly_revenue_change_chart', icon: 'widget' },
          { label: 'nvda_price_volatility_chart', icon: 'widget' }
        ],
        dataStream: [
          { label: 'chart_nvda_revenue_qoq_yoy', icon: 'widget' },
          { label: 'chart_nvda_core_segments_trend', icon: 'widget' }
        ],
        universe: [
          { label: 'chart_nvda_revenue_qoq_yoy', icon: 'widget' },
          { label: 'chart_nvda_core_segments_trend', icon: 'widget' }
        ]
      };
      
      // Store active mentions separately from textarea content
      let activeMentions = [];
      
      // Add a mention to the active list (without inserting text into textarea)
      function addMention(label) {
        if (!activeMentions.includes(label)) {
          activeMentions.push(label);
          renderMentionChips();
        }
      }
      
      // Remove a mention from the active list
      function removeMentionFromList(label) {
        activeMentions = activeMentions.filter(m => m !== label);
        renderMentionChips();
      }
      
      // Get final text with mentions appended
      function getFinalInputText() {
        const text = cfgChatInput.value.trim();
        const mentionTexts = activeMentions.map(label => '@`' + label + '`').join(' ');
        return text + (text && mentionTexts ? ' ' : '') + mentionTexts;
      }
      
      // Get mention item info from contextData
      function getMentionItem(label) {
        for (const category of Object.keys(contextData)) {
          const item = contextData[category].find(i => i.label === label);
          if (item) return item;
        }
        return null;
      }
      
      // Get icon SVG based on icon type
      function getIconSvg(iconType) {
        if (iconType === 'chart') {
          return '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M2 12h12v2H2v-2zm0-8h2v6H2V4zm4 2h2v4H6V6zm4-4h2v8h-2V2z" fill="currentColor"/></svg>';
        } else if (iconType === 'list') {
          return '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M2 3h12v2H2V3zm0 4h12v2H2V7zm0 4h8v2H2v-2z" fill="currentColor"/></svg>';
        } else if (iconType === 'refresh') {
          return '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 1a7 7 0 100 14A7 7 0 008 1zm0 1a6 6 0 110 12A6 6 0 008 2zm0 2v2h2l-2-2zm0 4v2h2l-2-2z" fill="currentColor"/><path d="M8 3l2 2-2 2M8 9l2 2-2 2" stroke="currentColor" stroke-width="1" fill="none" stroke-linecap="round"/></svg>';
        } else if (iconType === 'widget') {
          return '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="4" width="12" height="8" fill="none" stroke="currentColor" stroke-width="1"/><path d="M4 10l2-2 2 2 4-4 2 2v2H4z" fill="currentColor" opacity="0.6"/><circle cx="5" cy="6" r="0.8" fill="currentColor"/></svg>';
        }
        return '';
      }
      
      // Render mention chips
      function renderMentionChips() {
        const container = document.getElementById('mentionChipsContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Toggle class on parent card based on whether there are mentions
        const card = container.closest('.chat-input-card');
        if (card) {
          if (activeMentions.length > 0) {
            card.classList.add('has-mentions');
          } else {
            card.classList.remove('has-mentions');
          }
        }
        
        activeMentions.forEach(label => {
          const item = getMentionItem(label);
          const chip = document.createElement('div');
          chip.className = 'mention-chip';
          
          const icon = document.createElement('div');
          icon.className = 'mention-chip-icon';
          icon.innerHTML = getIconSvg(item ? item.icon : 'widget');
          
          const labelEl = document.createElement('span');
          labelEl.className = 'mention-chip-label';
          labelEl.textContent = label;
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'mention-chip-remove';
          removeBtn.type = 'button';
          removeBtn.setAttribute('aria-label', 'Remove');
          removeBtn.innerHTML = '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';
          removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
            removeMentionFromList(label);
          });
          
          chip.appendChild(icon);
          chip.appendChild(labelEl);
          chip.appendChild(removeBtn);
          container.appendChild(chip);
        });
      }
      
      function buildAddContextMenu() {
        if (!addContextBody) return;
        addContextBody.innerHTML = '';
        Object.keys(contextData).forEach(category => {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'add-context-category';
          const title = document.createElement('div');
          title.className = 'add-context-category-title';
          title.textContent = category.charAt(0).toUpperCase() + category.slice(1);
          categoryDiv.appendChild(title);
          contextData[category].forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'add-context-item';
            const icon = document.createElement('div');
            icon.className = 'add-context-item-icon';
            let iconSvg = '';
            if (item.icon === 'chart') {
              iconSvg = '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M2 12h12v2H2v-2zm0-8h2v6H2V4zm4 2h2v4H6V6zm4-4h2v8h-2V2z" fill="currentColor"/></svg>';
            } else if (item.icon === 'list') {
              iconSvg = '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M2 3h12v2H2V3zm0 4h12v2H2V7zm0 4h8v2H2v-2z" fill="currentColor"/></svg>';
            } else if (item.icon === 'refresh') {
              iconSvg = '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 1a7 7 0 100 14A7 7 0 008 1zm0 1a6 6 0 110 12A6 6 0 008 2zm0 2v2h2l-2-2zm0 4v2h2l-2-2z" fill="currentColor"/><path d="M8 3l2 2-2 2M8 9l2 2-2 2" stroke="currentColor" stroke-width="1" fill="none" stroke-linecap="round"/></svg>';
            } else {
              iconSvg = '<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="8" r="6" fill="none" stroke="currentColor" stroke-width="1"/><path d="M5 8h6M8 5v6" stroke="currentColor" stroke-width="1"/></svg>';
            }
            icon.innerHTML = iconSvg;
            const content = document.createElement('div');
            content.className = 'add-context-item-content';
            const label = document.createElement('div');
            label.className = 'add-context-item-label';
            label.textContent = item.label;
            content.appendChild(label);
            if (item.badge) {
              const badge = document.createElement('div');
              badge.className = 'add-context-item-badge';
              badge.textContent = item.badge;
              content.appendChild(badge);
            }
            itemDiv.appendChild(icon);
            itemDiv.appendChild(content);
            itemDiv.addEventListener('click', () => {
              addMention(item.label);
              hideAddContextMenu();
            });
            categoryDiv.appendChild(itemDiv);
          });
          addContextBody.appendChild(categoryDiv);
        });
      }
      
      function showAddContextMenu() {
        if (!addContextMenu) return;
        buildAddContextMenu();
        const inputRect = cfgChatInput.getBoundingClientRect();
        
        // Temporarily show menu to get its dimensions
        addContextMenu.style.visibility = 'hidden';
        addContextMenu.style.display = 'flex';
        const menuRect = addContextMenu.getBoundingClientRect();
        
        // Use fixed positioning relative to viewport
        const left = inputRect.left + 6;
        // Position menu so its bottom aligns with input top, expand upwards
        const top = inputRect.top - menuRect.height - 4;
        
        addContextMenu.style.left = left + 'px';
        addContextMenu.style.top = Math.max(4, top) + 'px';
        addContextMenu.style.visibility = 'visible';
        addContextMenu.classList.add('open');
      }
      
      function hideAddContextMenu() {
        if (!addContextMenu) return;
        addContextMenu.classList.remove('open');
        addContextMenu.style.visibility = '';
        addContextMenu.style.display = '';
      }
      
      if (chatAtBtn) {
        chatAtBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (addContextMenu && addContextMenu.classList.contains('open')) {
            hideAddContextMenu();
          } else {
            showAddContextMenu();
          }
        });
      }
      
      cfgChatInput.addEventListener('input', (e) => {
        // Remove any @`...` text that might have been typed or pasted
        const text = cfgChatInput.value;
        const cleanedText = text.replace(/@`([^`]+)`/g, '');
        if (cleanedText !== text) {
          const cursorPos = cfgChatInput.selectionStart;
          cfgChatInput.value = cleanedText;
          cfgChatInput.selectionStart = cfgChatInput.selectionEnd = Math.min(cursorPos, cleanedText.length);
        }
        
        // Check if user typed '@' to show menu
        try {
          const pos = cfgChatInput.selectionStart || 0;
          const prev = cfgChatInput.value.slice(pos - 1, pos);
          if (prev === '@') {
            showAddContextMenu();
          }
        } catch {}
      });
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && addContextMenu) {
          hideAddContextMenu();
        }
      });
      
      document.addEventListener('click', (e) => {
        const compose = document.querySelector('.chat-compose');
        if (compose && addContextMenu && !compose.contains(e.target) && !addContextMenu.contains(e.target)) {
          hideAddContextMenu();
        }
      });
      
      cfgChatSend.addEventListener('click', () => {
        const text = getFinalInputText();
        if (!text.trim()) return;
        const you = document.createElement('div');
        you.className = 'chat-msg msg-you';
        you.innerHTML = '<div class="chat-role">You</div><div>' + text + '</div>';
        cfgChatList.appendChild(you);
        cfgChatInput.value = '';
        activeMentions = [];
        renderMentionChips();
        setTimeout(() => {
          const ai = document.createElement('div');
          ai.className = 'chat-msg msg-ai';
          ai.innerHTML = '<div class="chat-role">AI</div><div>Noted. This box is for chatting about the current playbook.</div>';
          cfgChatList.appendChild(ai);
          cfgChatList.scrollTop = cfgChatList.scrollHeight;
        }, 500);
      });
      const tabsEls = document.querySelectorAll('.tabs .tab');
      const panes = {
        overview: document.getElementById('pane-overview'),
        analytics: document.getElementById('pane-analytics'),
        strategy: document.getElementById('pane-strategy'),
        feed: document.getElementById('pane-feed')
      };
      tabsEls.forEach(tab => {
        tab.addEventListener('click', () => {
          tabsEls.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          Object.values(panes).forEach(p => p.classList.add('hidden'));
          const key = tab.getAttribute('data-target');
          const pane = panes[key];
          if (pane) pane.classList.remove('hidden');
        });
      });
      
      // Initialize mention chips on page load
      renderMentionChips();
    </script>
  </body>
</html>
